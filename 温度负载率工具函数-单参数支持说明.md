# 温度负载率工具函数 - 单参数支持功能说明

## 🎯 功能概述

基于API接口的灵活性升级，工具函数现在支持**单参数设置**，用户可以只设置温度或只设置负载率，不再强制要求同时提供两个参数。这进一步提升了交互的灵活性和用户体验。

## ✨ 新增特性

### 1. API接口支持单参数

**接口1 (/api/asr)** 现在支持以下三种调用方式：

#### 方式1：同时传入温度和负载率
```bash
curl --location 'http://10.3.193.243:9000/api/asr' \
--header 'Content-Type: application/json' \
--data '{
    "temperature": "22.5",
    "load_rate": "90"
}'
```

响应：
```json
{
    "status": "success",
    "message": {
        "type": "confirm_request",
        "descripetion": "请确认是否设置参数",
        "temperature": 22.5,
        "load_rate": 90.0
    }
}
```

#### 方式2：只传入温度
```bash
curl --location 'http://10.3.193.243:9000/api/asr' \
--header 'Content-Type: application/json' \
--data '{
    "temperature": "22.5"
}'
```

响应：
```json
{
    "status": "success",
    "message": {
        "type": "confirm_request",
        "descripetion": "请确认是否设置参数",
        "temperature": 22.5
    }
}
```

#### 方式3：只传入负载率
```bash
curl --location 'http://10.3.193.243:9000/api/asr' \
--header 'Content-Type: application/json' \
--data '{
    "load_rate": "95"
}'
```

响应：
```json
{
    "status": "success",
    "message": {
        "type": "confirm_request",
        "descripetion": "请确认是否设置参数",
        "load_rate": 95.0
    }
}
```

### 2. 工具函数优化

#### 核心改进

1. **`call_asr_api` 函数优化**
   - 参数改为可选：`temperature=None, load_rate=None`
   - 智能构建payload，只添加非空参数
   - 支持单参数或双参数调用

2. **参数收集逻辑优化**
   - 判断条件从 `has_temperature and has_load_rate` 改为 `has_temperature or has_load_rate`
   - 只要有至少一个参数就可以进入确认阶段
   - 灵活构建确认信息，显示实际提供的参数

3. **用户提示优化**
   - 提示用户可以只设置一个参数
   - 提示用户可以直接确认当前参数
   - 提示用户可以继续添加其他参数

## 🗣️ 使用场景

### 场景1：只设置温度

```
👤 用户："设置温度22.5度"
🤖 小智："温度已设置为22.5℃。是否还需要设置负载率？
        也可以直接确认当前参数。"
👤 用户："确认"
🤖 小智："温度22.5℃，请确认是否正确？"
👤 用户："确认"
[系统调用API1(只传温度) + API2(第一次)]
🤖 小智："参数已确认。是否使用AI推荐模式？"
👤 用户："确认"
[系统调用API2(第二次)]
🤖 小智："✅ 已启动AI节能优化！"
```

### 场景2：只设置负载率

```
👤 用户："负载率设置为90千瓦"
🤖 小智："负载率已设置为90kw。是否还需要设置温度？
        也可以直接确认当前参数。"
👤 用户："就这样吧"
🤖 小智："负载率90kw，请确认是否正确？"
👤 用户："确认"
[系统调用API1(只传负载率) + API2(第一次)]
🤖 小智："参数已确认。是否使用AI推荐模式？"
👤 用户："好的"
[系统调用API2(第二次)]
🤖 小智："✅ 已启动AI节能优化！"
```

### 场景3：先设置一个参数，然后补充另一个

```
👤 用户："设置温度25度"
🤖 小智："温度已设置为25℃。是否还需要设置负载率？"
👤 用户："85千瓦"
🤖 小智："温度25℃，负载率85kw，请确认是否正确？"
👤 用户："确认"
[系统调用API1(双参数) + API2(第一次)]
...
```

### 场景4：只设置一个参数，然后使用预设值补充

```
👤 用户："设置温度28度"
🤖 小智："温度已设置为28℃。是否还需要设置负载率？"
👤 用户："用推荐值"
🤖 小智："温度28℃，负载率90kw（推荐值），请确认是否正确？"
👤 用户："确认"
...
```

## 📊 功能对比

| 特性 | v2.2 (之前) | v2.3 (现在) |
|------|------------|------------|
| 必须同时提供两个参数 | ✅ | ❌ |
| 可以只提供温度 | ❌ | ✅ |
| 可以只提供负载率 | ❌ | ✅ |
| 可以同时提供两个参数 | ✅ | ✅ |
| 支持预设参数 | ✅ | ✅ |
| 防止函数漏调用 | ✅ | ✅ |

## 🔧 技术实现细节

### 1. call_asr_api 函数改造

**之前**：
```python
def call_asr_api(base_url, temperature, load_rate):
    payload = {
        "temperature": str(temperature),
        "load_rate": str(load_rate)
    }
```

**现在**：
```python
def call_asr_api(base_url, temperature=None, load_rate=None):
    payload = {}
    if temperature is not None:
        payload["temperature"] = str(temperature)
    if load_rate is not None:
        payload["load_rate"] = str(load_rate)
```

### 2. 参数收集完成判断

**之前**：
```python
if has_temperature and has_load_rate and state["stage"] in ["init", "collecting"]:
    # 进入确认阶段
```

**现在**：
```python
if (has_temperature or has_load_rate) and state["stage"] in ["init", "collecting"]:
    # 只要有至少一个参数就可以进入确认阶段
```

### 3. 确认信息构建

**现在**：
```python
params_info = []
if has_temperature:
    params_info.append(f"温度: {state['temperature']}")
if has_load_rate:
    params_info.append(f"负载率: {state['load_rate']}")

params_str = "\n".join(params_info)
```

### 4. 日志输出优化

```python
if has_temperature and has_load_rate:
    logger.info(f"【参数收集完成】温度={temp_raw}℃, 负载率={load_raw}kw")
elif has_temperature:
    logger.info(f"【参数收集完成】温度={temp_raw}℃ (负载率未提供)")
else:
    logger.info(f"【参数收集完成】负载率={load_raw}kw (温度未提供)")
```

## 🎯 用户体验提升

### 1. 更灵活的使用方式
- ✅ 用户不需要记住两个参数都要提供
- ✅ 可以根据实际需求只设置一个参数
- ✅ 可以先设置一个，后续再补充

### 2. 更友好的提示
- ✅ 明确告知用户可以只设置一个参数
- ✅ 提示用户可以继续添加或直接确认
- ✅ 提示用户可以使用预设值

### 3. 保持原有优势
- ✅ 仍然支持双参数设置
- ✅ 仍然支持预设参数功能
- ✅ 仍然有防漏调用提醒
- ✅ 仍然是递进式两轮确认流程

## 📝 使用建议

### 推荐场景

1. **快速测试场景**
   - 只需要测试温度效果时：只设置温度
   - 只需要测试负载效果时：只设置负载率

2. **不确定场景**
   - 用户不确定某个参数值时：先设置已知的，其他使用推荐值
   - 用户想快速完成时：提供一个参数后直接确认

3. **渐进式设置场景**
   - 先设置主要参数
   - 根据系统提示决定是否补充其他参数

### 最佳实践

```
场景A：完整设置（最佳效果）
"设置温度22.5度，负载率90千瓦" → 完整两轮确认

场景B：单参数设置（快速灵活）
"设置温度22.5度" → "确认" → 完整两轮确认

场景C：混合使用（智能补充）
"设置温度28度" → "负载率用推荐值" → 完整两轮确认
```

## 🔍 日志示例

### 只设置温度的日志

```
================================================================================
【参数收集完成】温度=22.5℃ (负载率未提供)
================================================================================
【参数收集完成】单参数设置，API支持
【参数收集完成】状态已更新为 waiting_first_confirm，请求用户确认参数
...
【第一次确认-步骤1】准备调用ASR API: 温度=22.5℃ (仅温度)
【第一次确认-步骤1】✅ ASR API调用成功
```

### 只设置负载率的日志

```
================================================================================
【参数收集完成】负载率=90kw (温度未提供)
================================================================================
【参数收集完成】单参数设置，API支持
【参数收集完成】状态已更新为 waiting_first_confirm，请求用户确认参数
...
【第一次确认-步骤1】准备调用ASR API: 负载率=90kw (仅负载率)
【第一次确认-步骤1】✅ ASR API调用成功
```

## ✅ 测试验证

### 测试用例

1. **只设置温度**
   ```
   输入："设置温度22.5度" → "确认" → "确认"
   预期：✅ 成功完成流程
   ```

2. **只设置负载率**
   ```
   输入："负载率90千瓦" → "确认" → "确认"
   预期：✅ 成功完成流程
   ```

3. **先温度后负载率**
   ```
   输入："温度25度" → "负载率85千瓦" → "确认" → "确认"
   预期：✅ 成功完成流程
   ```

4. **单参数+预设值**
   ```
   输入："温度28度" → "用推荐值" → "确认" → "确认"
   预期：✅ 成功完成流程
   ```

## 🔄 版本信息

- **版本**：v2.3 - 单参数支持
- **更新日期**：2025年10月16日
- **主要改进**：
  - ✅ API接口支持单参数调用
  - ✅ 工具函数支持单参数设置
  - ✅ 优化参数收集逻辑
  - ✅ 优化用户提示信息
  - ✅ 增强日志输出
  - ✅ 保持原有所有功能

## 📚 相关文档

- 主函数：`main/xiaozhi-server/plugins_func/functions/get_temperature_load_rate.py`
- 流程优化说明：`温度负载率工具函数-流程优化说明.md`
- 预设参数功能：`温度负载率工具函数-预设参数功能说明.md`
- API集成文档：`docs/get_temperature_load_rate_api_integration.md`

## 🎉 总结

通过支持单参数设置，温度负载率工具函数现在提供了：

- ✅ **更高的灵活性**：用户可以根据需求选择设置方式
- ✅ **更好的体验**：不强制要求同时提供两个参数
- ✅ **更快的流程**：可以更快速地完成设置
- ✅ **完全兼容**：保持原有所有功能和优势

**现在，用户可以按照自己的方式，灵活地设置参数！** 🚀

---

**祝使用愉快！** 🎊

