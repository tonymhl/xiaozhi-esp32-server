# 小智ESP32服务器 - 离线部署快速操作指南

> 本指南帮助您快速完成打包和部署，已修复PowerShell脚本语法错误，并优化支持热更新工具函数。

---

## ✅ 已修复的问题

1. **PowerShell脚本语法错误** - 已完全修复Here-String语法问题（已通过语法验证）
2. **增加热更新支持** - 工具函数和配置文件支持在宿主机直接修改，重启容器即生效

### 修复详情

- ❌ 原问题：PowerShell的Here-String（`@"..."@`）语法对中文字符和特殊字符敏感
- ✅ 解决方案：改用数组+Join方法生成所有文本内容
- ✅ 验证状态：已通过PowerShell语法检查，可以正常运行

---

## 📦 第一步：打包（Windows环境）

### 1. 确认环境

```powershell
# 检查Docker Desktop是否运行
docker --version
docker-compose --version
```

### 2. 执行打包脚本

```powershell
# 进入项目根目录
cd D:\workspace\xiaozhi-esp32-server

# 执行打包（已修复语法错误）
.\scripts\offline-package.ps1
```

### 3. 打包过程

脚本会自动完成：
- ✅ 编译Docker镜像（包含您的工具函数）
- ✅ 拉取MySQL和Redis镜像
- ✅ 导出所有镜像为tar文件
- ✅ 复制配置文件和工具函数目录
- ✅ 生成部署脚本和文档
- ✅ 打包为tar.gz压缩包

### 4. 预期输出

```
xiaozhi-offline-deployment-20241016-153000.tar.gz
```

文件大小约：3-8GB（取决于镜像大小）

---

## 📤 第二步：传输到CentOS服务器

### 方式A: U盘/移动硬盘（推荐）

1. 将压缩包复制到U盘
2. U盘插入CentOS服务器
3. 复制到服务器目录

### 方式B: SCP网络传输

```powershell
# 在Windows上执行
scp xiaozhi-offline-deployment-*.tar.gz root@服务器IP:/root/
```

---

## 🚀 第三步：部署（CentOS环境）

### 1. 解压部署包

```bash
cd /root
tar -xzf xiaozhi-offline-deployment-*.tar.gz
cd xiaozhi-offline-deployment-*/
sed -i 's/\r$//' *.sh scripts/*.sh
```

### 2. 安装Docker（如未安装）

```bash
chmod +x install-docker-centos.sh
sudo ./install-docker-centos.sh
```

### 3. 一键部署

```bash
chmod +x offline-deploy.sh
sudo ./offline-deploy.sh
```

脚本会自动：
- ✅ 检查Docker环境
- ✅ 加载所有镜像
- ✅ 创建必要目录（包括plugins_func）
- ✅ 配置防火墙
- ✅ 启动所有服务
- ✅ 健康检查

### 4. 等待启动

首次启动需要1-3分钟初始化数据库，耐心等待。

---

## ✅ 第四步：验证部署

### 1. 检查容器状态

```bash
docker ps
```

应该看到4个容器都在运行：
- xiaozhi-esp32-server
- xiaozhi-esp32-server-web
- xiaozhi-esp32-server-db
- xiaozhi-esp32-server-redis

### 2. 访问Web管理界面

在浏览器打开：
```
http://服务器IP:8002
```

### 3. 验证工具函数

```bash
# 进入容器
docker exec -it xiaozhi-esp32-server bash

# 检查工具函数文件
ls -l /opt/xiaozhi-esp32-server/plugins_func/functions/

# 查看您的工具函数
cat /opt/xiaozhi-esp32-server/plugins_func/functions/get_temperature_load_rate.py

# 退出容器
exit
```

---

## 🔄 热更新功能（新增）

### 优势

现在支持在**宿主机上直接修改**工具函数和配置文件，**无需重新构建镜像**！

### 目录结构

```
/root/xiaozhi-offline-deployment-*/
├── plugins_func/              # 工具函数目录（已挂载到容器）
│   ├── functions/             # 您的工具函数
│   │   ├── get_temperature_load_rate.py  # 可以直接修改
│   │   └── 其他工具函数.py
│   └── register.py            # 函数注册文件
├── data/                      # 配置文件目录（已挂载到容器）
│   └── config.yaml            # 可以直接修改
└── docker-compose-offline.yml
```

### 修改工具函数

```bash
# 1. 在宿主机上直接编辑
vi /root/xiaozhi-offline-deployment-*/plugins_func/functions/get_temperature_load_rate.py

# 2. 修改完成后，重启容器使更改生效
cd /root/xiaozhi-offline-deployment-*/
docker-compose -f docker-compose-offline.yml restart xiaozhi-esp32-server

# 3. 验证更改
docker logs -f xiaozhi-esp32-server

docker-compose -f docker-compose-offline.yml logs --tail=200 -f xiaozhi-esp32-server
```

### 添加新工具函数

```bash
# 1. 创建新的工具函数文件
vi /root/xiaozhi-offline-deployment-*/plugins_func/functions/my_new_function.py

# 2. 如需注册，修改register.py
vi /root/xiaozhi-offline-deployment-*/plugins_func/register.py

# 3. 重启容器
docker-compose -f docker-compose-offline.yml restart xiaozhi-esp32-server
```

### 修改配置文件

```bash
# 1. 直接编辑配置
vi /root/xiaozhi-offline-deployment-*/data/config.yaml

# 2. 重启容器
docker-compose -f docker-compose-offline.yml restart xiaozhi-esp32-server
```

---

## 🔧 常用管理命令

### 查看服务状态

```bash
cd /root/xiaozhi-offline-deployment-*/
docker-compose -f docker-compose-offline.yml ps
```

### 查看日志

```bash
# 查看所有服务日志
docker-compose -f docker-compose-offline.yml logs -f

docker-compose -f docker-compose-offline.yml logs --tail=200 -f

# CPU 仪表盘
watch -n2 -d 'mpstat -P ALL 1 1 | tail -n +4; echo; uptime'  # CPU 仪表盘

# 只查看server服务日志
docker-compose -f docker-compose-offline.yml logs -f xiaozhi-esp32-server
```

### 重启服务

```bash
# 重启所有服务
docker-compose -f docker-compose-offline.yml restart

# 只重启server服务
docker-compose -f docker-compose-offline.yml restart xiaozhi-esp32-server
```

### 停止和启动

```bash
# 停止所有服务
docker-compose -f docker-compose-offline.yml down

# 启动所有服务
docker-compose -f docker-compose-offline.yml up -d
```

---

## ❓ 常见问题

### Q1: PowerShell脚本报错

**已修复！** 现在使用的是修复后的脚本，不会再出现语法错误。

### Q2: 端口被占用

```bash
# 修改端口映射
vi docker-compose-offline.yml

# 将端口改为其他值
ports:
  - "8100:8000"  # 将8000改为8100
  - "8102:8002"  # 将8002改为8102
```

### Q3: 工具函数修改后不生效

```bash
# 确保重启了容器
docker-compose -f docker-compose-offline.yml restart xiaozhi-esp32-server

# 查看容器内的文件是否更新
docker exec xiaozhi-esp32-server cat /opt/xiaozhi-esp32-server/plugins_func/functions/get_temperature_load_rate.py
```

### Q4: 数据库初始化慢

首次启动需要1-3分钟，可以查看日志：

```bash
docker logs -f xiaozhi-esp32-server-db
```

等待出现 "ready for connections" 字样。

### Q5: 外网无法访问

```bash
# 开放防火墙端口
firewall-cmd --zone=public --add-port=8000/tcp --permanent
firewall-cmd --zone=public --add-port=8002/tcp --permanent
firewall-cmd --zone=public --add-port=8003/tcp --permanent
firewall-cmd --reload
```

---

## 📊 部署成功标志

- ✅ 4个容器都在运行
- ✅ 可以访问 http://服务器IP:8002
- ✅ Web界面正常显示
- ✅ 可以在容器中看到工具函数文件
- ✅ 在宿主机修改文件后重启容器可生效

---

## 📚 详细文档

如需更详细的说明，请参考：

- `docs/offline-deployment-guide.md` - 完整部署指南
- `docs/offline-deployment-troubleshooting.md` - 故障排查手册
- `scripts/README.md` - 脚本使用说明

---

## 🎉 恭喜！

如果您看到这里，说明部署应该已经成功了！

现在您可以：
1. 在宿主机上直接修改工具函数
2. 修改配置文件
3. 重启容器使更改生效
4. 无需重新构建镜像

**享受灵活的开发体验吧！** 🚀

