# å°æ™ºESP32æœåŠ¡å™¨ - ç¦»çº¿éƒ¨ç½²å¿«é€Ÿæ“ä½œæŒ‡å—

> æœ¬æŒ‡å—å¸®åŠ©æ‚¨å¿«é€Ÿå®Œæˆæ‰“åŒ…å’Œéƒ¨ç½²ï¼Œå·²ä¿®å¤PowerShellè„šæœ¬è¯­æ³•é”™è¯¯ï¼Œå¹¶ä¼˜åŒ–æ”¯æŒçƒ­æ›´æ–°å·¥å…·å‡½æ•°ã€‚

---

## âœ… å·²ä¿®å¤çš„é—®é¢˜

1. **PowerShellè„šæœ¬è¯­æ³•é”™è¯¯** - å·²å®Œå…¨ä¿®å¤Here-Stringè¯­æ³•é—®é¢˜ï¼ˆå·²é€šè¿‡è¯­æ³•éªŒè¯ï¼‰
2. **å¢åŠ çƒ­æ›´æ–°æ”¯æŒ** - å·¥å…·å‡½æ•°å’Œé…ç½®æ–‡ä»¶æ”¯æŒåœ¨å®¿ä¸»æœºç›´æ¥ä¿®æ”¹ï¼Œé‡å¯å®¹å™¨å³ç”Ÿæ•ˆ

### ä¿®å¤è¯¦æƒ…

- âŒ åŸé—®é¢˜ï¼šPowerShellçš„Here-Stringï¼ˆ`@"..."@`ï¼‰è¯­æ³•å¯¹ä¸­æ–‡å­—ç¬¦å’Œç‰¹æ®Šå­—ç¬¦æ•æ„Ÿ
- âœ… è§£å†³æ–¹æ¡ˆï¼šæ”¹ç”¨æ•°ç»„+Joinæ–¹æ³•ç”Ÿæˆæ‰€æœ‰æ–‡æœ¬å†…å®¹
- âœ… éªŒè¯çŠ¶æ€ï¼šå·²é€šè¿‡PowerShellè¯­æ³•æ£€æŸ¥ï¼Œå¯ä»¥æ­£å¸¸è¿è¡Œ

---

## ğŸ“¦ ç¬¬ä¸€æ­¥ï¼šæ‰“åŒ…ï¼ˆWindowsç¯å¢ƒï¼‰

### 1. ç¡®è®¤ç¯å¢ƒ

```powershell
# æ£€æŸ¥Docker Desktopæ˜¯å¦è¿è¡Œ
docker --version
docker-compose --version
```

### 2. æ‰§è¡Œæ‰“åŒ…è„šæœ¬

```powershell
# è¿›å…¥é¡¹ç›®æ ¹ç›®å½•
cd D:\workspace\xiaozhi-esp32-server

# æ‰§è¡Œæ‰“åŒ…ï¼ˆå·²ä¿®å¤è¯­æ³•é”™è¯¯ï¼‰
.\scripts\offline-package.ps1
```

### 3. æ‰“åŒ…è¿‡ç¨‹

è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆï¼š
- âœ… ç¼–è¯‘Dockeré•œåƒï¼ˆåŒ…å«æ‚¨çš„å·¥å…·å‡½æ•°ï¼‰
- âœ… æ‹‰å–MySQLå’ŒRedisé•œåƒ
- âœ… å¯¼å‡ºæ‰€æœ‰é•œåƒä¸ºtaræ–‡ä»¶
- âœ… å¤åˆ¶é…ç½®æ–‡ä»¶å’Œå·¥å…·å‡½æ•°ç›®å½•
- âœ… ç”Ÿæˆéƒ¨ç½²è„šæœ¬å’Œæ–‡æ¡£
- âœ… æ‰“åŒ…ä¸ºtar.gzå‹ç¼©åŒ…

### 4. é¢„æœŸè¾“å‡º

```
xiaozhi-offline-deployment-20241016-153000.tar.gz
```

æ–‡ä»¶å¤§å°çº¦ï¼š3-8GBï¼ˆå–å†³äºé•œåƒå¤§å°ï¼‰

---

## ğŸ“¤ ç¬¬äºŒæ­¥ï¼šä¼ è¾“åˆ°CentOSæœåŠ¡å™¨

### æ–¹å¼A: Uç›˜/ç§»åŠ¨ç¡¬ç›˜ï¼ˆæ¨èï¼‰

1. å°†å‹ç¼©åŒ…å¤åˆ¶åˆ°Uç›˜
2. Uç›˜æ’å…¥CentOSæœåŠ¡å™¨
3. å¤åˆ¶åˆ°æœåŠ¡å™¨ç›®å½•

### æ–¹å¼B: SCPç½‘ç»œä¼ è¾“

```powershell
# åœ¨Windowsä¸Šæ‰§è¡Œ
scp xiaozhi-offline-deployment-*.tar.gz root@æœåŠ¡å™¨IP:/root/
```

---

## ğŸš€ ç¬¬ä¸‰æ­¥ï¼šéƒ¨ç½²ï¼ˆCentOSç¯å¢ƒï¼‰

### 1. è§£å‹éƒ¨ç½²åŒ…

```bash
cd /root
tar -xzf xiaozhi-offline-deployment-*.tar.gz
cd xiaozhi-offline-deployment-*/
sed -i 's/\r$//' *.sh scripts/*.sh
```

### 2. å®‰è£…Dockerï¼ˆå¦‚æœªå®‰è£…ï¼‰

```bash
chmod +x install-docker-centos.sh
sudo ./install-docker-centos.sh
```

### 3. ä¸€é”®éƒ¨ç½²

```bash
chmod +x offline-deploy.sh
sudo ./offline-deploy.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- âœ… æ£€æŸ¥Dockerç¯å¢ƒ
- âœ… åŠ è½½æ‰€æœ‰é•œåƒ
- âœ… åˆ›å»ºå¿…è¦ç›®å½•ï¼ˆåŒ…æ‹¬plugins_funcï¼‰
- âœ… é…ç½®é˜²ç«å¢™
- âœ… å¯åŠ¨æ‰€æœ‰æœåŠ¡
- âœ… å¥åº·æ£€æŸ¥

### 4. ç­‰å¾…å¯åŠ¨

é¦–æ¬¡å¯åŠ¨éœ€è¦1-3åˆ†é’Ÿåˆå§‹åŒ–æ•°æ®åº“ï¼Œè€å¿ƒç­‰å¾…ã€‚

---

## âœ… ç¬¬å››æ­¥ï¼šéªŒè¯éƒ¨ç½²

### 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€

```bash
docker ps
```

åº”è¯¥çœ‹åˆ°4ä¸ªå®¹å™¨éƒ½åœ¨è¿è¡Œï¼š
- xiaozhi-esp32-server
- xiaozhi-esp32-server-web
- xiaozhi-esp32-server-db
- xiaozhi-esp32-server-redis

### 2. è®¿é—®Webç®¡ç†ç•Œé¢

åœ¨æµè§ˆå™¨æ‰“å¼€ï¼š
```
http://æœåŠ¡å™¨IP:8002
```

### 3. éªŒè¯å·¥å…·å‡½æ•°

```bash
# è¿›å…¥å®¹å™¨
docker exec -it xiaozhi-esp32-server bash

# æ£€æŸ¥å·¥å…·å‡½æ•°æ–‡ä»¶
ls -l /opt/xiaozhi-esp32-server/plugins_func/functions/

# æŸ¥çœ‹æ‚¨çš„å·¥å…·å‡½æ•°
cat /opt/xiaozhi-esp32-server/plugins_func/functions/get_temperature_load_rate.py

# é€€å‡ºå®¹å™¨
exit
```

---

## ğŸ”„ çƒ­æ›´æ–°åŠŸèƒ½ï¼ˆæ–°å¢ï¼‰

### ä¼˜åŠ¿

ç°åœ¨æ”¯æŒåœ¨**å®¿ä¸»æœºä¸Šç›´æ¥ä¿®æ”¹**å·¥å…·å‡½æ•°å’Œé…ç½®æ–‡ä»¶ï¼Œ**æ— éœ€é‡æ–°æ„å»ºé•œåƒ**ï¼

### ç›®å½•ç»“æ„

```
/root/xiaozhi-offline-deployment-*/
â”œâ”€â”€ plugins_func/              # å·¥å…·å‡½æ•°ç›®å½•ï¼ˆå·²æŒ‚è½½åˆ°å®¹å™¨ï¼‰
â”‚   â”œâ”€â”€ functions/             # æ‚¨çš„å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ get_temperature_load_rate.py  # å¯ä»¥ç›´æ¥ä¿®æ”¹
â”‚   â”‚   â””â”€â”€ å…¶ä»–å·¥å…·å‡½æ•°.py
â”‚   â””â”€â”€ register.py            # å‡½æ•°æ³¨å†Œæ–‡ä»¶
â”œâ”€â”€ data/                      # é…ç½®æ–‡ä»¶ç›®å½•ï¼ˆå·²æŒ‚è½½åˆ°å®¹å™¨ï¼‰
â”‚   â””â”€â”€ config.yaml            # å¯ä»¥ç›´æ¥ä¿®æ”¹
â””â”€â”€ docker-compose-offline.yml
```

### ä¿®æ”¹å·¥å…·å‡½æ•°

```bash
# 1. åœ¨å®¿ä¸»æœºä¸Šç›´æ¥ç¼–è¾‘
vi /root/xiaozhi-offline-deployment-*/plugins_func/functions/get_temperature_load_rate.py

# 2. ä¿®æ”¹å®Œæˆåï¼Œé‡å¯å®¹å™¨ä½¿æ›´æ”¹ç”Ÿæ•ˆ
cd /root/xiaozhi-offline-deployment-*/
docker-compose -f docker-compose-offline.yml restart xiaozhi-esp32-server

# 3. éªŒè¯æ›´æ”¹
docker logs -f xiaozhi-esp32-server

docker-compose -f docker-compose-offline.yml logs --tail=200 -f xiaozhi-esp32-server
```

### æ·»åŠ æ–°å·¥å…·å‡½æ•°

```bash
# 1. åˆ›å»ºæ–°çš„å·¥å…·å‡½æ•°æ–‡ä»¶
vi /root/xiaozhi-offline-deployment-*/plugins_func/functions/my_new_function.py

# 2. å¦‚éœ€æ³¨å†Œï¼Œä¿®æ”¹register.py
vi /root/xiaozhi-offline-deployment-*/plugins_func/register.py

# 3. é‡å¯å®¹å™¨
docker-compose -f docker-compose-offline.yml restart xiaozhi-esp32-server
```

### ä¿®æ”¹é…ç½®æ–‡ä»¶

```bash
# 1. ç›´æ¥ç¼–è¾‘é…ç½®
vi /root/xiaozhi-offline-deployment-*/data/config.yaml

# 2. é‡å¯å®¹å™¨
docker-compose -f docker-compose-offline.yml restart xiaozhi-esp32-server
```

---

## ğŸ”§ å¸¸ç”¨ç®¡ç†å‘½ä»¤

### æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```bash
cd /root/xiaozhi-offline-deployment-*/
docker-compose -f docker-compose-offline.yml ps
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose -f docker-compose-offline.yml logs -f

docker-compose -f docker-compose-offline.yml logs --tail=200 -f

# CPU ä»ªè¡¨ç›˜
watch -n2 -d 'mpstat -P ALL 1 1 | tail -n +4; echo; uptime'  # CPU ä»ªè¡¨ç›˜

# åªæŸ¥çœ‹serveræœåŠ¡æ—¥å¿—
docker-compose -f docker-compose-offline.yml logs -f xiaozhi-esp32-server
```

### é‡å¯æœåŠ¡

```bash
# é‡å¯æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose-offline.yml restart

# åªé‡å¯serveræœåŠ¡
docker-compose -f docker-compose-offline.yml restart xiaozhi-esp32-server
```

### åœæ­¢å’Œå¯åŠ¨

```bash
# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose-offline.yml down

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose-offline.yml up -d
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: PowerShellè„šæœ¬æŠ¥é”™

**å·²ä¿®å¤ï¼** ç°åœ¨ä½¿ç”¨çš„æ˜¯ä¿®å¤åçš„è„šæœ¬ï¼Œä¸ä¼šå†å‡ºç°è¯­æ³•é”™è¯¯ã€‚

### Q2: ç«¯å£è¢«å ç”¨

```bash
# ä¿®æ”¹ç«¯å£æ˜ å°„
vi docker-compose-offline.yml

# å°†ç«¯å£æ”¹ä¸ºå…¶ä»–å€¼
ports:
  - "8100:8000"  # å°†8000æ”¹ä¸º8100
  - "8102:8002"  # å°†8002æ”¹ä¸º8102
```

### Q3: å·¥å…·å‡½æ•°ä¿®æ”¹åä¸ç”Ÿæ•ˆ

```bash
# ç¡®ä¿é‡å¯äº†å®¹å™¨
docker-compose -f docker-compose-offline.yml restart xiaozhi-esp32-server

# æŸ¥çœ‹å®¹å™¨å†…çš„æ–‡ä»¶æ˜¯å¦æ›´æ–°
docker exec xiaozhi-esp32-server cat /opt/xiaozhi-esp32-server/plugins_func/functions/get_temperature_load_rate.py
```

### Q4: æ•°æ®åº“åˆå§‹åŒ–æ…¢

é¦–æ¬¡å¯åŠ¨éœ€è¦1-3åˆ†é’Ÿï¼Œå¯ä»¥æŸ¥çœ‹æ—¥å¿—ï¼š

```bash
docker logs -f xiaozhi-esp32-server-db
```

ç­‰å¾…å‡ºç° "ready for connections" å­—æ ·ã€‚

### Q5: å¤–ç½‘æ— æ³•è®¿é—®

```bash
# å¼€æ”¾é˜²ç«å¢™ç«¯å£
firewall-cmd --zone=public --add-port=8000/tcp --permanent
firewall-cmd --zone=public --add-port=8002/tcp --permanent
firewall-cmd --zone=public --add-port=8003/tcp --permanent
firewall-cmd --reload
```

---

## ğŸ“Š éƒ¨ç½²æˆåŠŸæ ‡å¿—

- âœ… 4ä¸ªå®¹å™¨éƒ½åœ¨è¿è¡Œ
- âœ… å¯ä»¥è®¿é—® http://æœåŠ¡å™¨IP:8002
- âœ… Webç•Œé¢æ­£å¸¸æ˜¾ç¤º
- âœ… å¯ä»¥åœ¨å®¹å™¨ä¸­çœ‹åˆ°å·¥å…·å‡½æ•°æ–‡ä»¶
- âœ… åœ¨å®¿ä¸»æœºä¿®æ”¹æ–‡ä»¶åé‡å¯å®¹å™¨å¯ç”Ÿæ•ˆ

---

## ğŸ“š è¯¦ç»†æ–‡æ¡£

å¦‚éœ€æ›´è¯¦ç»†çš„è¯´æ˜ï¼Œè¯·å‚è€ƒï¼š

- `docs/offline-deployment-guide.md` - å®Œæ•´éƒ¨ç½²æŒ‡å—
- `docs/offline-deployment-troubleshooting.md` - æ•…éšœæ’æŸ¥æ‰‹å†Œ
- `scripts/README.md` - è„šæœ¬ä½¿ç”¨è¯´æ˜

---

## ğŸ‰ æ­å–œï¼

å¦‚æœæ‚¨çœ‹åˆ°è¿™é‡Œï¼Œè¯´æ˜éƒ¨ç½²åº”è¯¥å·²ç»æˆåŠŸäº†ï¼

ç°åœ¨æ‚¨å¯ä»¥ï¼š
1. åœ¨å®¿ä¸»æœºä¸Šç›´æ¥ä¿®æ”¹å·¥å…·å‡½æ•°
2. ä¿®æ”¹é…ç½®æ–‡ä»¶
3. é‡å¯å®¹å™¨ä½¿æ›´æ”¹ç”Ÿæ•ˆ
4. æ— éœ€é‡æ–°æ„å»ºé•œåƒ

**äº«å—çµæ´»çš„å¼€å‘ä½“éªŒå§ï¼** ğŸš€

