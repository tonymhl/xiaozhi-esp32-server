# Windows/Linux 换行符问题修复指南

## 🔍 问题描述

在Windows上打包的部署包，在Linux上部署时出现校验和验证失败：

```bash
md5sum: 'web.tar'$'\r': No such file or directory
: FAILED open or read
```

**原因**: Windows使用CRLF（`\r\n`）换行符，Linux使用LF（`\n`）换行符。

---

## ✅ 已修复

我已经修复了两个地方：

### 1. PowerShell打包脚本（`scripts/offline-package.ps1`）
- ✅ 现在生成Unix格式（LF）的`checksums.md5`文件
- ✅ 使用 `[System.IO.File]::WriteAllText` 精确控制换行符

### 2. 部署脚本（`scripts/offline-deploy.sh`）
- ✅ 自动检测并转换CRLF到LF
- ✅ 如果MD5校验失败，自动使用tar命令验证文件完整性
- ✅ 更健壮的错误处理

---

## 🚀 解决方案

### 方案A：重新打包（推荐）

使用修复后的脚本重新打包：

```powershell
# 1. 清理旧的打包文件
.\scripts\clean-and-rebuild.ps1

# 2. 重新打包
.\scripts\offline-package.ps1
```

新生成的部署包将使用正确的Unix换行符。

---

### 方案B：修复现有部署包（应急方案）

如果已经将部署包传输到了CentOS服务器，可以在服务器上手动修复：

```bash
# 1. 解压部署包
cd /root
tar -xzf xiaozhi-offline-deployment-*.tar.gz
cd xiaozhi-offline-deployment-*/images

# 2. 修复checksums.md5文件
# 方法1: 使用dos2unix（如果已安装）
dos2unix checksums.md5

# 方法2: 使用sed（通用方法）
sed -i 's/\r$//' checksums.md5

# 3. 验证修复
file checksums.md5
# 应该显示: checksums.md5: ASCII text

# 4. 重新验证
md5sum -c checksums.md5

# 5. 如果验证通过，继续部署
cd ..
./offline-deploy.sh
```

---

### 方案C：使用更新的部署脚本

更新后的 `offline-deploy.sh` 脚本已经内置了自动修复功能，直接运行即可：

```bash
cd /root/xiaozhi-offline-deployment-*/
chmod +x offline-deploy.sh
./offline-deploy.sh
```

脚本会自动：
1. 检测Windows换行符
2. 自动转换为Unix格式
3. 如果MD5失败，使用tar命令验证
4. 只有在文件真正损坏时才报错

---

## 🔧 验证修复效果

### 在Windows上（打包后）

```powershell
# 检查生成的checksums.md5文件
Get-Content xiaozhi-offline-deployment-*/images/checksums.md5 -Raw | Format-Hex
# 应该看到 0A（LF），而不是 0D 0A（CRLF）
```

### 在Linux上（部署前）

```bash
# 检查文件格式
file images/checksums.md5
# 应该显示: ASCII text（不应该有"CRLF"字样）

# 查看十六进制
od -c images/checksums.md5 | head
# 应该只看到\n，不应该有\r
```

---

## 📋 预防措施

### 1. 使用修复后的脚本

始终使用最新版本的打包脚本：
- `scripts/offline-package.ps1`（已修复）
- `scripts/offline-package.sh`（Linux版本）

### 2. Git配置

如果使用Git，确保正确配置：

```bash
# 查看当前配置
git config core.autocrlf

# Windows开发环境推荐设置
git config --global core.autocrlf true

# Linux环境
git config --global core.autocrlf input
```

### 3. 文件传输

使用二进制模式传输：
- SCP: 默认二进制模式（无问题）
- FTP: 使用binary模式，不要用ASCII模式
- 压缩包: tar.gz格式会保持原始格式

---

## ❓ 常见问题

### Q1: 为什么只有checksums.md5有问题？

A: 因为：
- `.tar` 文件是二进制，不受换行符影响
- `checksums.md5` 是文本文件，会受影响
- 其他脚本文件（`.sh`）在Linux上执行前会被bash自动处理

### Q2: 重新打包会很慢吗？

A: 不会特别慢：
- 如果镜像已经存在，编译步骤会很快（使用缓存）
- 只需要重新导出镜像和打包
- 大约需要5-15分钟

### Q3: 能否只修复checksums.md5而不重新打包？

A: 可以，但不推荐：
```bash
# 在已有的压缩包中修复
tar -xzf xiaozhi-offline-deployment-*.tar.gz
cd xiaozhi-offline-deployment-*/images
sed -i 's/\r$//' checksums.md5
cd ../..
tar -czf xiaozhi-offline-deployment-fixed.tar.gz xiaozhi-offline-deployment-*/
```

### Q4: 更新的部署脚本能处理其他问题吗？

A: 是的，新脚本增加了：
- ✅ 自动换行符转换
- ✅ tar文件完整性备用验证
- ✅ 更详细的错误信息
- ✅ 更好的容错能力

---

## 🎯 推荐操作流程

### 对于新打包：

1. 使用更新的 `scripts/offline-package.ps1`
2. 打包完成后验证（可选）
3. 正常传输和部署

### 对于现有部署包：

1. 使用更新的 `scripts/offline-deploy.sh`
2. 脚本会自动处理换行符问题
3. 如果还有问题，使用方案B手动修复

---

## 📞 需要帮助？

如果遇到其他问题：

1. 检查 `docker logs` 确认不是镜像本身的问题
2. 确认网络传输没有损坏文件（MD5校验）
3. 参考 `docs/offline-deployment-troubleshooting.md`

---

**现在您可以放心使用修复后的脚本进行打包和部署了！** ✅

