# ğŸ¯ æœ€ç®€å•çš„ä¿®å¤æ–¹æ¡ˆ - ä½¿ç”¨å®˜æ–¹é…ç½®æ–‡ä»¶

## âœ… ä¸ºä»€ä¹ˆè¿™ä¸ªæ–¹æ¡ˆæœ€å®‰å…¨ï¼Ÿ

1. **ä½¿ç”¨å®˜æ–¹éªŒè¯è¿‡çš„é…ç½®**ï¼š`docs\docker\start.sh` å’Œ `docs\docker\nginx.conf`
2. **é›¶é£é™©**ï¼šä¸åˆ›å»ºæ–°æ–‡ä»¶ï¼Œä¸ä¿®æ”¹é…ç½®
3. **æç®€å•**ï¼š1ä¸ªä¼ è¾“å‘½ä»¤ + 2è¡Œé…ç½®ä¿®æ”¹
4. **è€—æ—¶æœ€å°‘**ï¼š2-3 åˆ†é’Ÿå®Œæˆ

---

## ğŸ“‹ å®Œæ•´æ“ä½œæ­¥éª¤

### æ­¥éª¤1ï¼šåœ¨ Windows ä¸Šä¼ è¾“å®˜æ–¹é…ç½®æ–‡ä»¶ï¼ˆ1åˆ†é’Ÿï¼‰

```powershell
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œï¼ˆå½“å‰å·²ç»åœ¨æ­£ç¡®ä½ç½®ï¼‰
cd D:\workspace\xiaozhi-esp32-server

# ä¼ è¾“ä¸¤ä¸ªå®˜æ–¹é…ç½®æ–‡ä»¶åˆ° CentOS
scp docs\docker\start.sh docs\docker\nginx.conf root@10.80.127.51:/root/
```

**è¯´æ˜**ï¼š
- `start.sh`ï¼šå®˜æ–¹çš„å¯åŠ¨è„šæœ¬ï¼ˆå¯åŠ¨ Java + Nginxï¼‰
- `nginx.conf`ï¼šå®˜æ–¹çš„ Nginx é…ç½®

---

### æ­¥éª¤2ï¼šåœ¨ CentOS ä¸Šé…ç½®æŒ‚è½½ï¼ˆ1åˆ†é’Ÿï¼‰

```bash
# SSH ç™»å½•åˆ° CentOS
ssh root@10.80.127.51

# è¿›å…¥éƒ¨ç½²ç›®å½•
cd ~/xiaozhi-offline-deployment-*/

# åˆ›å»ºé…ç½®ç›®å½•
mkdir -p docker-config

# ç§»åŠ¨ä¼ è¾“çš„æ–‡ä»¶åˆ°é…ç½®ç›®å½•
mv ~/start.sh docker-config/
mv ~/nginx.conf docker-config/

# è®¾ç½®æƒé™å’Œæ¢è¡Œç¬¦
chmod +x docker-config/start.sh
sed -i 's/\r$//' docker-config/start.sh
sed -i 's/\r$//' docker-config/nginx.conf

# éªŒè¯æ–‡ä»¶
ls -lh docker-config/
cat docker-config/start.sh
```

---

### æ­¥éª¤3ï¼šä¿®æ”¹ docker-compose é…ç½®ï¼ˆ1åˆ†é’Ÿï¼‰

```bash
# å¤‡ä»½åŸæ–‡ä»¶
cp docker-compose-offline.yml docker-compose-offline.yml.backup

# ç¼–è¾‘æ–‡ä»¶
vi docker-compose-offline.yml
```

æ‰¾åˆ° `xiaozhi-esp32-server-web` æœåŠ¡ï¼Œåœ¨ `volumes` éƒ¨åˆ†æ·»åŠ ä¸¤è¡Œï¼š

```yaml
  xiaozhi-esp32-server-web:
    image: xiaozhi-esp32-server:web_custom
    container_name: xiaozhi-esp32-server-web
    restart: always
    # ... å…¶ä»–é…ç½®ä¿æŒä¸å˜ ...
    volumes:
      # åŸæœ‰çš„ volume
      - ./uploadfile:/uploadfile
      # æ–°å¢ï¼šæŒ‚è½½å®˜æ–¹é…ç½®æ–‡ä»¶
      - ./docker-config/start.sh:/start.sh:ro
      - ./docker-config/nginx.conf:/etc/nginx/nginx.conf:ro
```

**å…³é”®ç‚¹**ï¼š
- âœ… `/start.sh` - å®¹å™¨æ ¹ç›®å½•ï¼ˆDockerfile ä¸­ CMD è°ƒç”¨çš„ä½ç½®ï¼‰
- âœ… `/etc/nginx/nginx.conf` - Nginx é»˜è®¤é…ç½®æ–‡ä»¶ä½ç½®
- âœ… `:ro` - åªè¯»æŒ‚è½½ï¼Œæ›´å®‰å…¨

ä¿å­˜å¹¶é€€å‡ºï¼ˆæŒ‰ `Esc`ï¼Œè¾“å…¥ `:wq`ï¼ŒæŒ‰ `Enter`ï¼‰

---

### æ­¥éª¤4ï¼šé‡å¯ web å®¹å™¨ï¼ˆ1åˆ†é’Ÿï¼‰

```bash
# åœæ­¢å¹¶åˆ é™¤ web å®¹å™¨ï¼ˆä¿ç•™é•œåƒå’Œæ•°æ®ï¼‰
docker-compose -f docker-compose-offline.yml stop xiaozhi-esp32-server-web
docker-compose -f docker-compose-offline.yml rm -f xiaozhi-esp32-server-web

# é‡æ–°å¯åŠ¨
docker-compose -f docker-compose-offline.yml up -d xiaozhi-esp32-server-web

# ç­‰å¾… 5 ç§’
sleep 5

# æŸ¥çœ‹æ—¥å¿—ï¼ˆåº”è¯¥ä¸å†æœ‰ start.sh é”™è¯¯ï¼‰
docker logs -f xiaozhi-esp32-server-web
```

---

## âœ… é¢„æœŸç»“æœ

### æ­£ç¡®çš„æ—¥å¿—åº”è¯¥æ˜¯ï¼š

```bash
Starting Java backend...
# Java å¯åŠ¨æ—¥å¿— ...
Starting Nginx...
# Nginx å¯åŠ¨æˆåŠŸ
```

### ä¸åº”è¯¥å†çœ‹åˆ°ï¼š

```bash
âŒ exec /start.sh: no such file or directory
```

### éªŒè¯æœåŠ¡

```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps | grep web

# æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tlnp | grep 8002

# æµ‹è¯•è®¿é—®
curl http://localhost:8002

# æµè§ˆå™¨è®¿é—®
# http://10.80.127.51:8002
```

---

## ğŸ“Š å®˜æ–¹é…ç½®æ–‡ä»¶è¯´æ˜

### start.sh åšäº†ä»€ä¹ˆï¼Ÿ

```bash
1. å¯åŠ¨ Java åç«¯ï¼ˆç›‘å¬ 8003 ç«¯å£ï¼‰
   - ä¼ é€’æ•°æ®åº“è¿æ¥å‚æ•°
   - ä¼ é€’ Redis è¿æ¥å‚æ•°
   - åå°è¿è¡Œ

2. å¯åŠ¨ Nginxï¼ˆå‰å°è¿è¡Œï¼Œä¿æŒå®¹å™¨å­˜æ´»ï¼‰
   - ç›‘å¬ 8002 ç«¯å£
   - ä»£ç†åç«¯è¯·æ±‚åˆ° 8003
```

### nginx.conf åšäº†ä»€ä¹ˆï¼Ÿ

```
1. ç›‘å¬ 8002 ç«¯å£
2. å‰ç«¯é™æ€æ–‡ä»¶ï¼š/usr/share/nginx/html
3. åç«¯ API ä»£ç†ï¼š/xiaozhi/ â†’ http://127.0.0.1:8003
```

è¿™ä¸ Dockerfile-web çš„æ„å»ºå®Œå…¨åŒ¹é…ï¼

---

## ğŸ”§ å®Œæ•´çš„ä¸€é”®æ‰§è¡Œè„šæœ¬ï¼ˆå¯é€‰ï¼‰

å¦‚æœæ‚¨æƒ³ä¸€æ¬¡æ€§æ‰§è¡Œæ‰€æœ‰æ“ä½œï¼ˆåœ¨ CentOS ä¸Šï¼‰ï¼š

```bash
# å¤åˆ¶ä»¥ä¸‹æ•´ä¸ªä»£ç å—åˆ° CentOS ç»ˆç«¯

cd ~/xiaozhi-offline-deployment-*/ && \
mkdir -p docker-config && \
mv ~/start.sh docker-config/ 2>/dev/null && \
mv ~/nginx.conf docker-config/ 2>/dev/null && \
chmod +x docker-config/start.sh && \
sed -i 's/\r$//' docker-config/start.sh && \
sed -i 's/\r$//' docker-config/nginx.conf && \
echo "âœ“ é…ç½®æ–‡ä»¶å‡†å¤‡å®Œæˆ" && \
ls -lh docker-config/ && \
echo "" && \
echo "ç°åœ¨è¯·ä¿®æ”¹ docker-compose-offline.ymlï¼Œåœ¨ xiaozhi-esp32-server-web çš„ volumes éƒ¨åˆ†æ·»åŠ ï¼š" && \
echo "  - ./docker-config/start.sh:/start.sh:ro" && \
echo "  - ./docker-config/nginx.conf:/etc/nginx/nginx.conf:ro"
```

---

## âš ï¸ å¦‚æœé‡åˆ°é—®é¢˜

### é—®é¢˜1ï¼šæ–‡ä»¶ä¼ è¾“å¤±è´¥

```powershell
# æ£€æŸ¥ç½‘ç»œè¿æ¥
ping 10.80.127.51

# æ£€æŸ¥ SSH è¿æ¥
ssh root@10.80.127.51 "echo 'Connection OK'"

# é‡æ–°ä¼ è¾“
scp docs\docker\start.sh docs\docker\nginx.conf root@10.80.127.51:/root/
```

### é—®é¢˜2ï¼šå®¹å™¨ä»ç„¶æŠ¥é”™

```bash
# è¿›å…¥å®¹å™¨æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
docker exec -it xiaozhi-esp32-server-web ls -la /start.sh
docker exec -it xiaozhi-esp32-server-web ls -la /etc/nginx/nginx.conf

# æ£€æŸ¥æ–‡ä»¶å†…å®¹
docker exec -it xiaozhi-esp32-server-web cat /start.sh

# æ£€æŸ¥æ–‡ä»¶æƒé™
docker exec -it xiaozhi-esp32-server-web stat /start.sh
```

### é—®é¢˜3ï¼šæƒ³è¦å›æ»š

```bash
# åœæ­¢å®¹å™¨
docker-compose -f docker-compose-offline.yml stop xiaozhi-esp32-server-web

# æ¢å¤åŸå§‹é…ç½®
cp docker-compose-offline.yml.backup docker-compose-offline.yml

# åˆ é™¤é…ç½®ç›®å½•
rm -rf docker-config/

# é‡å¯å®¹å™¨
docker-compose -f docker-compose-offline.yml up -d xiaozhi-esp32-server-web
```

---

## ğŸ¯ ä¸å…¶ä»–æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | æ–‡ä»¶æ¥æº | é£é™© | è€—æ—¶ | æ¨èåº¦ |
|------|----------|------|------|--------|
| **æœ¬æ–¹æ¡ˆ** | å®˜æ–¹åŸå§‹ | æ—  | 2-3åˆ†é’Ÿ | â­â­â­â­â­ |
| ä¹‹å‰çš„æ–¹æ¡ˆ1 | æ‰‹åŠ¨åˆ›å»º | é…ç½®å¯èƒ½ä¸å¯¹ | 2-3åˆ†é’Ÿ | â­â­ |
| æ–¹æ¡ˆ2 | é‡å»ºé•œåƒ | æ—  | 10-15åˆ†é’Ÿ | â­â­â­â­ |

---

## âœ… æ€»ç»“

è¿™ä¸ªæ–¹æ¡ˆï¼š
1. âœ… **æœ€å®‰å…¨**ï¼šä½¿ç”¨å®˜æ–¹éªŒè¯è¿‡çš„é…ç½®æ–‡ä»¶
2. âœ… **æœ€ç®€å•**ï¼šåªéœ€ä¼ è¾“2ä¸ªæ–‡ä»¶
3. âœ… **æœ€å¿«é€Ÿ**ï¼š2-3åˆ†é’Ÿå®Œæˆ
4. âœ… **æœ€å¯é **ï¼šä¸ä¼šå¼•å…¥æ–°é—®é¢˜
5. âœ… **æ˜“ç»´æŠ¤**ï¼šåç»­å¯ç›´æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶

---

## ğŸš€ ç«‹å³å¼€å§‹

### Windows ä¸Šï¼ˆ1æ¡å‘½ä»¤ï¼‰

```powershell
scp docs\docker\start.sh docs\docker\nginx.conf root@10.80.127.51:/root/
```

### CentOS ä¸Šï¼ˆ3æ¡å‘½ä»¤ï¼‰

```bash
cd ~/xiaozhi-offline-deployment-*/
mkdir -p docker-config
mv ~/start.sh ~/nginx.conf docker-config/
chmod +x docker-config/start.sh
```

ç„¶åä¿®æ”¹ `docker-compose-offline.yml` æ·»åŠ  volume æŒ‚è½½ï¼Œé‡å¯å®¹å™¨å³å¯ï¼

---

**è¿™æ˜¯ç›®å‰æœ€ä¼˜çš„è§£å†³æ–¹æ¡ˆï¼** ğŸ‰

