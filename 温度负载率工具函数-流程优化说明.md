# 温度负载率工具函数 - 流程优化说明

## 📋 更新概述

根据您的测试反馈，已优化工具函数的API调用流程，确保符合您的业务需求。

## 🔄 优化后的完整流程

### 流程图

```
┌─────────────────────────────────────────┐
│ 用户输入温度和负载率                      │
│ "设置温度22.5度，负载率90千瓦"            │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 参数收集与验证                           │
│ - 解析温度：22.5℃                       │
│ - 解析负载率：90kw                       │
│ - 验证范围                               │
│ - 状态更新为: waiting_first_confirm     │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 系统询问：请确认参数                     │
│ "温度22.5℃，负载率90kw，是否正确？"      │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 👤 用户第一次确认："确认"                │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 【第一次确认 - 步骤1】                   │
│ 调用 API1: /api/asr                     │
│ POST {"temperature": "22.5",            │
│       "load_rate": "90"}                │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 【第一次确认 - 步骤2】                   │
│ 立即调用 API2: /api/confirm (第一次)    │
│ POST {"status": 1}                      │
│ 响应：{"stage": 1, ...}                 │
│ 状态更新为: waiting_second_confirm      │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 系统询问：使用AI推荐模式？               │
│ "是否使用AI推荐模式进行节能优化？"        │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 👤 用户第二次确认："确认"                │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 【第二次确认】                           │
│ 调用 API2: /api/confirm (第二次)        │
│ POST {"status": 1}                      │
│ 响应：{"stage": 2, ...}                 │
│ 状态更新为: completed                   │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ ✅ 完成流程                              │
│ "已确认使用AI推荐模式，开始AI节能优化"    │
└─────────────────────────────────────────┘
```

## 🎯 关键优化点

### 1. 用户确认次数
- **2次**：用户只需要确认两次
  - 第一次：确认温度和负载率参数
  - 第二次：确认使用AI推荐模式

### 2. API调用次数
- **3次**：系统共调用3次API
  - 第1次：`call_asr_api` - 提交参数
  - 第2次：`call_confirm_api` (stage=1) - 确认参数
  - 第3次：`call_confirm_api` (stage=2) - 确认AI模式

### 3. 关键时机
- **第一次用户确认时**：同时调用API1和API2（第一次）
- **第二次用户确认时**：调用API2（第二次）

## 📊 状态流转

```
init (初始)
  ↓
collecting (收集参数中)
  ↓
waiting_first_confirm (等待第一次确认)
  ↓
waiting_second_confirm (等待第二次确认)
  ↓
completed (完成)
```

## 🔍 详细日志输出

所有关键步骤都已添加详细的日志标记，便于排查：

### 参数收集阶段
```
【参数收集】收到温度输入: 22.5度
【参数收集】✅ 温度已更新: 22.5℃ (原始值: 22.5)
【参数收集】收到负载率输入: 90千瓦
【参数收集】✅ 负载率已更新: 90kw
```

### 参数收集完成
```
================================================================================
【参数收集完成】温度=22.5℃, 负载率=90kw
================================================================================
【参数收集完成】✅ 使用预设参数，预期毫秒级响应
【参数收集完成】状态已更新为 waiting_first_confirm，请求用户确认参数
```

### 第一次确认
```
================================================================================
【第一次确认】用户确认参数
================================================================================
【第一次确认-步骤1】准备调用ASR API: 温度=22.5℃, 负载率=90kw
【第一次确认-步骤1】✅ ASR API调用成功
【第一次确认-步骤1】响应数据: {...}
【第一次确认-步骤2】准备调用确认API（第一次）...
【第一次确认-步骤2】✅ 确认API调用成功
【第一次确认-步骤2】响应数据: {...}
【第一次确认-步骤2】✅ 成功！已确认设置参数
【第一次确认】两个API都调用成功，状态已更新为 waiting_second_confirm
【第一次确认】请求用户第二次确认（AI推荐模式）
```

### 第二次确认
```
================================================================================
【第二次确认】用户确认使用AI推荐模式
================================================================================
【第二次确认】准备调用确认API（第二次）...
【第二次确认】API调用成功，响应数据: {...}
【第二次确认】✅ 成功！已确认使用AI推荐模式，开始AI节能优化
【第二次确认】流程完成，清除状态
【第二次确认】返回完成消息
```

## 📝 代码关键改动

### 1. 状态定义更新
```python
"stage": "init",  # init/collecting/waiting_first_confirm/waiting_second_confirm/completed
```

### 2. 参数收集完成后
- **旧逻辑**：立即调用API1，然后进入确认状态
- **新逻辑**：仅询问用户确认，进入 `waiting_first_confirm` 状态

### 3. 第一次确认处理
- **新逻辑**：用户确认后，立即连续调用两个API
  ```python
  # 步骤1: 调用API1
  success1, data1, error1 = call_asr_api(api_base_url, temp_raw, load_raw)
  
  # 步骤2: 立即调用API2（第一次）
  success2, data2, error2 = call_confirm_api(api_base_url, 1)
  ```

### 4. 第二次确认处理
- **保持不变**：用户确认后，调用API2（第二次）

## ✅ 测试验证

### 测试步骤

1. **启动服务**
   ```bash
   cd main/xiaozhi-server
   python app.py
   ```

2. **语音输入**
   ```
   "设置温度22.5度，负载率90千瓦"
   ```

3. **观察日志**
   - 查看参数收集日志
   - 查看状态变更为 `waiting_first_confirm`

4. **第一次确认**
   ```
   "确认"
   ```

5. **观察日志**
   - 查看"【第一次确认-步骤1】"日志（API1调用）
   - 查看"【第一次确认-步骤2】"日志（API2第一次调用）
   - 确认两个API都成功
   - 查看状态变更为 `waiting_second_confirm`

6. **第二次确认**
   ```
   "确认"
   ```

7. **观察日志**
   - 查看"【第二次确认】"日志（API2第二次调用）
   - 确认流程完成

### 预期结果

- ✅ 用户只需确认2次
- ✅ 第一次确认时，两个API依次调用
- ✅ 第二次确认时，第三个API调用
- ✅ 所有日志清晰标记，便于排查

## 🐛 故障排查

### 如何查看日志

日志中搜索以下关键词：
- `【参数收集】` - 参数收集相关
- `【参数收集完成】` - 参数收集完成
- `【第一次确认】` - 第一次确认流程
- `【第二次确认】` - 第二次确认流程
- `【取消操作】` - 取消操作

### 常见问题

**Q: 第一次确认后，只调用了一个API？**
A: 检查日志，确认是否有"【第一次确认-步骤2】"的日志。如果API1失败，不会调用API2。

**Q: 日志中看到两次"【第一次确认】"？**
A: 检查 `confirm` 参数的默认值是否为 `False`（不是 `True`）

**Q: API调用超时？**
A: 检查是否使用预设参数 (22.5, 90) 或 (28, 95.6)，非预设参数可能需要10-30秒

## 📚 相关文件

- 主函数：`main/xiaozhi-server/plugins_func/functions/get_temperature_load_rate.py`
- API文档：`docs/get_temperature_load_rate_api_integration.md`
- 使用指南：`温度负载率工具函数使用说明.md`

## 🎉 完成状态

- ✅ 流程逻辑优化完成
- ✅ 详细日志添加完成
- ✅ 代码语法验证通过
- ✅ 状态流转清晰明确
- ✅ 符合业务需求

---

**更新日期**：2025年10月16日  
**版本**：v2.1 - 流程优化版

祝测试顺利！🚀

