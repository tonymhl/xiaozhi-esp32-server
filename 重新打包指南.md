# 🔄 重新打包指南

## 📋 问题诊断

您当前遇到的错误：
```
xiaozhi-esp32-server-web | exec /start.sh: no such file or directory
```

**根本原因**：您使用的是**旧版本镜像**（在修复 `.dockerignore` 之前构建的），镜像中缺少 `start.sh` 文件。

---

## ✅ 解决方案：重新打包

### 步骤 1：清理旧镜像和容器

在 **Windows 开发机** 上执行：

```powershell
# 停止并删除所有相关容器
docker stop xiaozhi-esp32-server xiaozhi-esp32-server-web xiaozhi-esp32-server-db xiaozhi-esp32-server-redis
docker rm xiaozhi-esp32-server xiaozhi-esp32-server-web xiaozhi-esp32-server-db xiaozhi-esp32-server-redis

# 删除旧镜像
docker rmi xiaozhi-esp32-server:server_custom xiaozhi-esp32-server:web_custom

# 清理构建缓存（重要！）
docker builder prune -af
```

在 **CentOS 目标服务器** 上执行：

```bash
# 停止所有服务
cd ~/xiaozhi-offline-deployment-*/
docker-compose -f docker-compose-offline.yml down

# 删除旧镜像
docker rmi xiaozhi-esp32-server:server_custom xiaozhi-esp32-server:web_custom mysql:latest redis:latest

# 清理构建缓存
docker builder prune -af

# 删除旧的部署包
cd ~
rm -rf xiaozhi-offline-deployment-*
```

---

### 步骤 2：在 Windows 上重新打包

```powershell
# 进入项目目录
cd D:\workspace\xiaozhi-esp32-server

# 执行打包脚本
.\scripts\offline-package.ps1
```

**预计时间**：30-40 分钟

**注意事项**：
- ✅ `.dockerignore` 已修复（包含 `!docs/docker/`）
- ✅ `requirements.txt` 已修复（PyTorch 依赖正确注释）
- ✅ `Dockerfile-server` 已修复（使用 PyTorch 官方 CPU 索引）
- ✅ 打包脚本会复制隐藏配置文件（`.config.yaml`）

---

### 步骤 3：传输新的部署包

```powershell
# 使用 SCP 传输到 CentOS
scp xiaozhi-offline-deployment-*.tar.gz root@10.80.127.51:/root/
```

---

### 步骤 4：在 CentOS 上重新部署

```bash
# 解压新的部署包
cd /root
tar -xzf xiaozhi-offline-deployment-*.tar.gz
cd xiaozhi-offline-deployment-*/

# 转换脚本换行符（如果需要）
sed -i 's/\r$//' *.sh scripts/*.sh

# 执行部署
chmod +x offline-deploy.sh
./offline-deploy.sh
```

---

## 🎯 部署成功后的验证

### 1. 检查所有容器运行状态

```bash
docker ps
```

预期输出：所有 4 个容器都在运行

### 2. 检查 Web 容器日志（不应再有 start.sh 错误）

```bash
docker logs xiaozhi-esp32-server-web
```

预期输出：应该看到 Nginx 和 Java 服务的启动日志

### 3. 检查 Server 容器日志（不应再有连接拒绝错误）

```bash
docker logs xiaozhi-esp32-server
```

预期输出：应该成功连接到 manager-api

### 4. 访问 Web 界面

```
http://10.80.127.51:8002
```

---

## 🔧 配置 manager-api.url

部署成功后，配置 `data/.config.yaml`：

```bash
cd ~/xiaozhi-offline-deployment-*/
vi data/.config.yaml
```

修改以下内容：

```yaml
manager-api:
  # Docker 部署必须使用服务名
  url: http://xiaozhi-esp32-server-web:8002/xiaozhi
  # 从 Web 界面获取 secret（登录后在系统设置中查看）
  secret: 你的-secret-key
```

**重要**：
- ✅ **url 必须使用服务名** `xiaozhi-esp32-server-web`，不要用 IP 地址
- ✅ **secret 需要登录 Web 界面后获取**（位置：系统设置 → 服务器配置 → server.secret）

保存后重启 server 容器：

```bash
docker-compose -f docker-compose-offline.yml restart xiaozhi-esp32-server
```

---

## 📊 完整流程时间估算

| 步骤 | 时间 |
|------|------|
| 清理旧环境 | 5 分钟 |
| Windows 重新打包 | 30-40 分钟 |
| 传输部署包 | 5-10 分钟（取决于网速）|
| CentOS 部署 | 5-10 分钟 |
| 配置和验证 | 5 分钟 |
| **总计** | **50-70 分钟** |

---

## ⚠️ 常见问题

### Q1: 打包时 PyTorch 下载很慢怎么办？

**A**: PyTorch 从官方源下载可能较慢，可以：
1. 使用代理
2. 或者耐心等待（首次下载约 200MB）
3. 后续打包会使用 Docker 缓存，速度会快很多

### Q2: 如何确认 .dockerignore 已生效？

**A**: 测试构建时查看日志：
```powershell
docker build --no-cache --progress=plain -t test-web -f .\Dockerfile-web . 2>&1 | Select-String -Pattern "docs/docker|start.sh"
```

应该能看到 `COPY docs/docker/start.sh` 等信息。

### Q3: 部署后仍然有问题怎么办？

**A**: 按以下顺序排查：
1. 检查容器日志：`docker logs <容器名>`
2. 进入容器检查文件：`docker exec -it xiaozhi-esp32-server-web ls -la /`
3. 查看部署日志：检查是否有 MD5 校验错误
4. 参考 `紧急修复指南-Web服务启动失败.md`

---

## 📞 技术支持

如果遇到问题：
1. 查看 `PyTorch依赖修复说明.md` - PyTorch 相关问题
2. 查看 `换行符问题修复指南.md` - 换行符相关问题
3. 查看 `紧急修复指南-Web服务启动失败.md` - Web 服务问题
4. 查看 `docs/offline-deployment-guide.md` - 完整部署指南

---

## ✅ 核心修复点总结

本次修复涉及的关键文件：

1. **`.dockerignore`** - 添加 `!docs/docker/` 确保 start.sh 被包含
2. **`requirements.txt`** - 注释掉 torch/torchaudio（在 Dockerfile 中单独安装）
3. **`Dockerfile-server`** - 使用 PyTorch 官方 CPU 索引
4. **`scripts/offline-package.ps1`** - 复制隐藏配置文件（`.config.yaml`）
5. **`scripts/offline-package.sh`** - 同上（Linux 版本）

所有修复已完成，现在重新打包即可解决问题！🎉

