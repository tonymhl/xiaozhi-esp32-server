# 离线打包方案优化说明

## 📋 优化内容总结

基于您的反馈，我对离线打包方案进行了以下三项重要优化：

---

## 1. ✅ Sherpa ASR模型完整打包支持

### 问题
虽然打包脚本会复制整个`models`目录，但docker-compose配置中只挂载了单个文件（`SenseVoiceSmall/model.pt`），导致Sherpa模型无法被容器访问。

### 解决方案
**修改前**：
```yaml
volumes:
  # Model Files
  - ./models/SenseVoiceSmall/model.pt:/opt/xiaozhi-esp32-server/models/SenseVoiceSmall/model.pt
```

**修改后**：
```yaml
volumes:
  # Model Files - 挂载整个models目录，支持所有模型
  - ./models:/opt/xiaozhi-esp32-server/models
```

### 优势
- ✅ **完整支持**：自动包含所有模型目录，包括：
  - `SenseVoiceSmall/` - FunASR语音识别模型
  - `sherpa-onnx-sense-voice-zh-en-ja-ko-yue-2024-07-17/` - Sherpa ONNX模型
  - `snakers4_silero-vad/` - VAD语音活动检测模型
- ✅ **热更新**：在宿主机`models`目录添加新模型后，重启容器即可生效
- ✅ **灵活性**：无需修改docker-compose配置即可添加新模型

### 验证方法
部署后，在服务器上验证Sherpa模型文件：
```bash
cd ~/xiaozhi-esp32-server/xiaozhi-offline-deployment-*/

# 检查宿主机模型文件
ls -lh models/sherpa-onnx-sense-voice-zh-en-ja-ko-yue-2024-07-17/

# 检查容器内模型文件
sudo docker exec xiaozhi-esp32-server ls -lh /opt/xiaozhi-esp32-server/models/sherpa-onnx-sense-voice-zh-en-ja-ko-yue-2024-07-17/

# 期望输出：
# model.int8.onnx
# tokens.txt
```

---

## 2. ✅ 移除资源限制，让服务充分运行

### 问题
所有服务（server、web、db、redis）都配置了`deploy.resources`资源限制，可能限制服务性能表现。

### 您的观点正确！
**理由**：
1. **首次部署应先观察**：应该让服务在实际负载下充分运行，收集资源占用数据
2. **硬件差异**：不同服务器的硬件配置差异很大，统一限制不合理
3. **性能优先**：AI推理、语音识别等任务需要充足资源，限制会影响响应速度
4. **后期优化**：有了实际数据后，再根据需要设置合理限制

### 解决方案
**修改前**（每个服务都有类似配置）：
```yaml
xiaozhi-esp32-server:
  deploy:
    resources:
      limits:
        cpus: '4'
        memory: 8G
      reservations:
        cpus: '2'
        memory: 4G
```

**修改后**（所有服务的资源限制已注释）：
```yaml
xiaozhi-esp32-server:
  # deploy:  # 移除资源限制，让服务充分运行以观察实际资源占用
  #   resources:
  #     limits:
  #       cpus: '4'
  #       memory: 8G
  #     reservations:
  #       cpus: '2'
  #       memory: 4G
```

### 优势
- ✅ **性能最大化**：服务可以使用所有可用资源，响应速度更快
- ✅ **灵活性**：适配不同硬件配置的服务器
- ✅ **便于观察**：可以准确测量实际资源需求
- ✅ **易于调优**：基于真实数据后期可以添加合理限制

### 资源监控建议
部署后，使用以下命令监控实际资源占用：

```bash
# 实时监控所有容器资源
sudo docker stats

# 查看特定容器资源
sudo docker stats xiaozhi-esp32-server --no-stream

# 记录24小时资源数据（可选）
while true; do 
  echo "$(date): $(sudo docker stats --no-stream --format 'table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}' | grep xiaozhi)" >> resource-monitor.log
  sleep 300  # 每5分钟记录一次
done &
```

### 何时添加资源限制？
建议在以下情况下考虑添加限制：
1. **多应用共存**：服务器上还运行其他应用，需要避免资源争抢
2. **成本控制**：云服务器按资源计费，需要精确控制成本
3. **稳定性优先**：防止某个服务占用过多资源导致系统不稳定
4. **已有数据**：已经收集了足够的资源占用数据，可以设置合理阈值

---

## 3. 🤔 MySQL版本问题 - 需要您决策

### 背景说明

#### 您遇到的问题（刚才）
```
[ERROR] [MY-000067] [Server] unknown variable 'innodb_log_file_size=128M'.
xiaozhi-esp32-server-db exited with code 1
```

**原因**：使用`mysql:latest`拉取到了MySQL 9.5.0，该版本废弃了`innodb_log_file_size`参数。

#### 版本差异说明

| 标签 | 当前最新版本 | 稳定性 | 兼容性 | 说明 |
|------|------------|--------|--------|------|
| `mysql:latest` | 9.5.0 (2025年10月) | ⚠️ 不稳定 | ❌ 不兼容 | 废弃了多个配置参数 |
| `mysql:8.0` | 8.0.40 | ✅ 稳定 | ✅ 完全兼容 | 长期支持版本（LTS） |
| `mysql:8` | 同8.0.40 | ✅ 稳定 | ✅ 完全兼容 | 自动跟随8.x最新版 |
| `mysql:5.7` | 5.7.x | ⚠️ EOL | ✅ 兼容 | 已停止支持 |

#### 为什么本地可以用`latest`？

**关键点**：您本地的`mysql:latest`实际上是**之前拉取的旧版本**。

```bash
# 查看您本地实际的MySQL版本
docker images mysql

# 可能的输出：
# mysql   latest   xxxxxx   3 months ago   ...
# 这个镜像实际上是3个月前的MySQL 8.0.37，而不是最新的9.5.0
```

**Docker标签的特性**：
- `latest`标签不是固定的，它总是指向**最新发布的版本**
- 如果您3个月前拉取了`mysql:latest`，那时拉到的是MySQL 8.0.37
- 如果您今天重新拉取`mysql:latest`，会拉到MySQL 9.5.0
- **离线部署时**，如果打包时拉取`latest`，可能会拉到不兼容的新版本

### 🎯 推荐方案（已采用）

**使用 `mysql:8.0` 指定版本**

#### 理由
1. ✅ **稳定性**：MySQL 8.0是长期支持版本（LTS），经过充分测试
2. ✅ **兼容性**：完全兼容项目的所有配置参数
3. ✅ **可预测性**：无论何时、何地拉取，都是8.0.x版本
4. ✅ **官方推荐**：MySQL官方推荐生产环境使用8.0
5. ✅ **作者原意**：项目作者使用的配置参数基于MySQL 8.0设计

#### 当前配置
```yaml
xiaozhi-esp32-server-db:
  image: mysql:8.0  # 指定8.0版本
```

---

### 🔀 备选方案（如果您坚持用latest）

如果您确实希望使用`mysql:latest`，需要额外修改：

#### 方案A：使用`mysql:latest`并清理配置

```yaml
xiaozhi-esp32-server-db:
  image: mysql:latest
  command:
    - --character-set-server=utf8mb4
    - --collation-server=utf8mb4_unicode_ci
    - --max_connections=1000
    # 移除所有MySQL 8.0特有的参数
    # 不要添加 --innodb_buffer_pool_size（9.x可能也会废弃）
```

**风险**：
- ⚠️ MySQL 9.x仍在快速迭代，未来版本可能继续废弃参数
- ⚠️ 性能调优参数缺失，可能影响高并发场景
- ⚠️ 升级Docker时可能拉到更新版本导致不兼容

#### 方案B：使用`mysql:8`（折中方案）

```yaml
xiaozhi-esp32-server-db:
  image: mysql:8  # 自动跟随8.x最新版本（如8.0.40 -> 8.0.41）
```

**优势**：
- ✅ 保持在MySQL 8.x版本范围内
- ✅ 自动获取8.x的安全补丁和bug修复
- ⚠️ 仍可能在8.x小版本升级时遇到兼容性问题（概率较低）

---

### 📊 版本选择对比

| 方案 | 镜像标签 | 稳定性 | 兼容性 | 可预测性 | 推荐度 |
|------|---------|--------|--------|----------|--------|
| **推荐** | `mysql:8.0` | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 折中 | `mysql:8` | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| 不推荐 | `mysql:latest` | ⭐⭐ | ⭐⭐ | ⭐ | ⭐ |

---

### 🎬 如何修改版本（如果需要）

如果您希望改为其他版本，修改以下文件：

#### 1. 修改docker-compose模板
```bash
# 编辑文件
vi scripts/docker-compose-offline.template.yml

# 找到第100行左右，修改：
image: mysql:8.0     # 改为 mysql:latest 或 mysql:8
```

#### 2. 修改打包脚本
```powershell
# 编辑文件
notepad scripts\offline-package.ps1

# 找到第132行左右，修改：
docker pull mysql:8.0     # 改为 mysql:latest 或 mysql:8

# 找到第153行左右，修改：
docker save mysql:8.0     # 改为 mysql:latest 或 mysql:8
```

#### 3. 重新打包
```powershell
cd D:\workspace\xiaozhi-esp32-server
.\scripts\offline-package.ps1
```

---

## 🎯 我的建议

### 当前配置（推荐保持）

1. ✅ **模型挂载**：整个`models`目录，支持Sherpa ASR
2. ✅ **资源限制**：已全部移除，让服务充分运行
3. ✅ **MySQL版本**：`mysql:8.0`，稳定且兼容

### 理由

**关于MySQL版本**：
- 您刚才遇到的错误就证明了`latest`的不可预测性
- 离线部署的核心就是**环境一致性**和**可预测性**
- 使用`mysql:8.0`可以确保任何时候打包都得到相同的结果
- 如果未来需要升级到MySQL 9.x，可以等其稳定后再统一升级

**如果您仍希望使用`latest`**：
- 我建议至少使用`mysql:8`作为折中
- 这样可以获得8.x的更新，又不会跳到不兼容的9.x

---

## 📦 验证优化效果

重新打包并部署后，验证优化效果：

### 1. 验证Sherpa模型
```bash
# 在服务器上
cd ~/xiaozhi-esp32-server/xiaozhi-offline-deployment-*/

# 检查模型文件
ls -lh models/sherpa-onnx-sense-voice-zh-en-ja-ko-yue-2024-07-17/

# 检查容器内模型
sudo docker exec xiaozhi-esp32-server ls -lh /opt/xiaozhi-esp32-server/models/sherpa-onnx-sense-voice-zh-en-ja-ko-yue-2024-07-17/

# 测试Sherpa ASR（需要配置data/.config.yaml使用Sherpa）
# 确认智控台的ASR配置选择了SherpaASR
```

### 2. 验证资源使用
```bash
# 实时监控资源
sudo docker stats

# 检查是否有资源限制（应该显示为不限制）
sudo docker inspect xiaozhi-esp32-server | grep -A 20 "Resources"
# 应该看到所有限制为0（表示不限制）
```

### 3. 验证MySQL版本
```bash
# 检查MySQL镜像版本
sudo docker images | grep mysql

# 检查MySQL运行版本
sudo docker exec xiaozhi-esp32-server-db mysql -V

# 期望输出：mysql  Ver 8.0.x for Linux...
```

---

## 🚀 下一步操作

### 1. 确认配置（可选）
如果您希望修改MySQL版本，请按照上面"如何修改版本"部分操作。

### 2. 重新打包（在Windows上）
```powershell
cd D:\workspace\xiaozhi-esp32-server

# 运行优化后的打包脚本
.\scripts\offline-package.ps1

# 等待打包完成（约10-30分钟）
# 生成：xiaozhi-offline-deployment-YYYYMMDD-HHMMSS.tar.gz
```

### 3. 传输到服务器
```powershell
scp xiaozhi-offline-deployment-*.tar.gz root@服务器IP:/root/
```

### 4. 部署（在服务器上）
```bash
# 备份旧部署（如果需要）
cd ~/xiaozhi-esp32-server
mv xiaozhi-offline-deployment-* xiaozhi-offline-deployment-old-$(date +%Y%m%d)

# 解压新包
tar -xzf /root/xiaozhi-offline-deployment-*.tar.gz
cd xiaozhi-offline-deployment-*/

# 如果是首次部署
chmod +x offline-deploy.sh install-docker-centos.sh
sudo ./offline-deploy.sh

# 如果是更新部署
sudo docker-compose -f docker-compose-offline.yml down
cd ../xiaozhi-offline-deployment-新目录/images
sudo docker load -i server.tar
sudo docker load -i web.tar
sudo docker load -i mysql.tar
cd ..
sudo docker-compose -f docker-compose-offline.yml up -d
```

---

## 📞 需要帮助？

如果您：
1. **想修改MySQL版本**：请告诉我您希望使用哪个版本（latest、8、8.0）
2. **遇到部署问题**：提供错误日志和容器状态
3. **需要性能调优**：分享资源监控数据，我可以帮您设置合理限制

---

## ✅ 优化总结

| 优化项 | 优化前 | 优化后 | 效果 |
|--------|--------|--------|------|
| **模型支持** | 只支持单个模型文件 | 支持所有模型目录 | ✅ Sherpa ASR可用 |
| **资源限制** | 严格限制CPU/内存 | 无限制 | ✅ 性能最大化 |
| **MySQL版本** | mysql:latest (9.5.0不兼容) | mysql:8.0 (稳定兼容) | ✅ 可预测、稳定 |

所有优化已完成，您可以放心重新打包部署了！🚀

