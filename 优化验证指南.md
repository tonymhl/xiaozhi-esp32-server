# 离线打包方案优化验证指南

本指南帮助您验证三项优化是否成功生效。

---

## ✅ 验证清单

### 1️⃣ Sherpa ASR模型支持验证

#### 在Windows打包机上验证

```powershell
cd D:\workspace\xiaozhi-esp32-server

# 1. 确认本地有Sherpa模型
ls main\xiaozhi-server\models\sherpa-onnx-sense-voice-zh-en-ja-ko-yue-2024-07-17\

# 期望输出：
# model.int8.onnx
# tokens.txt

# 2. 打包后检查离线包
cd xiaozhi-offline-deployment-*/models/
ls

# 期望输出：应该包含以下目录
# SenseVoiceSmall/
# sherpa-onnx-sense-voice-zh-en-ja-ko-yue-2024-07-17/
# snakers4_silero-vad/

# 3. 验证docker-compose配置
cat ../docker-compose-offline.yml | grep -A 2 "# Model Files"

# 期望输出：
# # Model Files
# - ./models:/opt/xiaozhi-esp32-server/models
```

#### 在CentOS服务器上验证

```bash
cd ~/xiaozhi-esp32-server/xiaozhi-offline-deployment-*/

# 1. 检查宿主机模型文件
echo "=== 检查SenseVoice模型 ==="
ls -lh models/SenseVoiceSmall/

echo -e "\n=== 检查Sherpa ONNX模型 ==="
ls -lh models/sherpa-onnx-sense-voice-zh-en-ja-ko-yue-2024-07-17/

echo -e "\n=== 检查VAD模型 ==="
ls -lh models/snakers4_silero-vad/

# 2. 检查容器内模型文件
echo -e "\n=== 验证容器内Sherpa模型 ==="
sudo docker exec xiaozhi-esp32-server ls -lh /opt/xiaozhi-esp32-server/models/sherpa-onnx-sense-voice-zh-en-ja-ko-yue-2024-07-17/

# 期望输出：
# -rw-r--r-- 1 root root  XXM ... model.int8.onnx
# -rw-r--r-- 1 root root  XXK ... tokens.txt

# 3. 验证模型挂载
echo -e "\n=== 验证所有模型目录 ==="
sudo docker exec xiaozhi-esp32-server ls -la /opt/xiaozhi-esp32-server/models/

# 期望看到：
# SenseVoiceSmall
# sherpa-onnx-sense-voice-zh-en-ja-ko-yue-2024-07-17
# snakers4_silero-vad
```

#### 功能测试（可选）

在智控台配置使用Sherpa ASR：

1. 登录智控台：http://服务器IP:8002
2. 进入「模型配置」→「语音识别模型」
3. 找到「Sherpa ASR」配置
4. 启用并保存
5. 使用小智设备测试语音识别

**期望结果**：
- ✅ 能够正常识别语音
- ✅ 容器日志中显示使用Sherpa ONNX模型
- ✅ 识别速度和准确率符合预期

---

### 2️⃣ 资源限制移除验证

#### 在CentOS服务器上验证

```bash
cd ~/xiaozhi-esp32-server/xiaozhi-offline-deployment-*/

# 1. 检查docker-compose配置
echo "=== 检查配置文件中的资源限制 ==="
grep -n "deploy:" docker-compose-offline.yml

# 期望输出：所有deploy行都应该被注释（以#开头）
# 41:    # deploy:  # 移除资源限制，让服务充分运行以观察实际资源占用
# 84:    # deploy:  # 移除资源限制
# 124:   # deploy:  # 移除资源限制
# 161:   # deploy:  # 移除资源限制

# 2. 检查容器实际资源限制
echo -e "\n=== 检查xiaozhi-esp32-server容器资源限制 ==="
sudo docker inspect xiaozhi-esp32-server | grep -A 30 '"Resources"'

# 期望输出：所有限制为0或null
# "Memory": 0,
# "NanoCpus": 0,
# "CpuShares": 0,
# "MemoryReservation": 0,

echo -e "\n=== 检查xiaozhi-esp32-server-web容器资源限制 ==="
sudo docker inspect xiaozhi-esp32-server-web | grep -A 30 '"Resources"'

echo -e "\n=== 检查xiaozhi-esp32-server-db容器资源限制 ==="
sudo docker inspect xiaozhi-esp32-server-db | grep -A 30 '"Resources"'

echo -e "\n=== 检查xiaozhi-esp32-server-redis容器资源限制 ==="
sudo docker inspect xiaozhi-esp32-server-redis | grep -A 30 '"Resources"'

# 3. 实时监控资源使用
echo -e "\n=== 实时资源监控（按Ctrl+C退出）==="
sudo docker stats
```

#### 资源使用观察

运行服务一段时间后，记录资源占用：

```bash
# 记录资源快照
echo "=== $(date) 资源快照 ===" >> resource-snapshot.log
sudo docker stats --no-stream >> resource-snapshot.log
echo "" >> resource-snapshot.log

# 查看资源快照
cat resource-snapshot.log
```

**期望结果**：
- ✅ CPU和内存使用率根据实际负载动态变化
- ✅ 没有被人为限制在某个固定值
- ✅ 高负载时（如语音识别）资源可以充分使用
- ✅ 低负载时自动降低资源占用

#### 性能对比（可选）

如果之前有资源限制的版本，可以对比性能：

| 指标 | 有资源限制 | 无资源限制 | 改善 |
|------|-----------|-----------|------|
| 语音识别延迟 | XXX ms | XXX ms | ±X% |
| LLM响应时间 | XXX ms | XXX ms | ±X% |
| TTS生成时间 | XXX ms | XXX ms | ±X% |
| CPU使用峰值 | 限制在X% | 可达X% | +X% |
| 内存使用峰值 | 限制在XG | 可达XG | +XG |

---

### 3️⃣ MySQL版本验证

#### 在Windows打包机上验证

```powershell
cd D:\workspace\xiaozhi-esp32-server

# 1. 检查打包脚本配置
Select-String -Path scripts\offline-package.ps1 -Pattern "mysql:"

# 期望输出：
# 132: docker pull mysql:8.0
# 153: docker save mysql:8.0

# 2. 检查docker-compose模板
Select-String -Path scripts\docker-compose-offline.template.yml -Pattern "mysql:"

# 期望输出：
# 100:    image: mysql:8.0

# 3. 打包后检查实际镜像
cd xiaozhi-offline-deployment-*/images/
tar -tzf mysql.tar | head -20

# 期望输出：应该包含manifest.json等文件
```

#### 在CentOS服务器上验证

```bash
cd ~/xiaozhi-esp32-server/xiaozhi-offline-deployment-*/

# 1. 检查docker-compose配置
echo "=== 检查docker-compose中的MySQL配置 ==="
grep -A 5 "xiaozhi-esp32-server-db:" docker-compose-offline.yml | grep "image:"

# 期望输出：
# image: mysql:8.0

# 2. 检查已加载的MySQL镜像
echo -e "\n=== 检查MySQL镜像 ==="
sudo docker images | grep mysql

# 期望输出：
# mysql   8.0   xxxxxxxx   X weeks ago   XXX MB

# 3. 检查MySQL容器运行版本
echo -e "\n=== 检查MySQL运行版本 ==="
sudo docker exec xiaozhi-esp32-server-db mysql -V

# 期望输出：
# mysql  Ver 8.0.x for Linux on x86_64 (MySQL Community Server - GPL)

# 4. 验证MySQL正常启动
echo -e "\n=== 检查MySQL容器状态 ==="
sudo docker ps | grep xiaozhi-esp32-server-db

# 期望输出：
# xiaozhi-esp32-server-db   ... Up X minutes (healthy)   3306/tcp

# 5. 检查MySQL日志（应该没有错误）
echo -e "\n=== 检查MySQL日志（最后20行）==="
sudo docker logs --tail 20 xiaozhi-esp32-server-db

# 期望输出：应该看到类似以下内容
# [System] [MY-010931] [Server] /usr/sbin/mysqld: ready for connections. Version: '8.0.x'
# 不应该看到：
# [ERROR] [MY-000067] [Server] unknown variable 'innodb_log_file_size=128M'

# 6. 测试数据库连接
echo -e "\n=== 测试数据库连接 ==="
sudo docker exec xiaozhi-esp32-server-db mysqladmin ping -h localhost -u root -p123456

# 期望输出：
# mysqld is alive

# 7. 查看数据库列表
echo -e "\n=== 查看数据库列表 ==="
sudo docker exec -it xiaozhi-esp32-server-db mysql -uroot -p123456 -e "SHOW DATABASES;"

# 期望输出：应该包含
# +--------------------+
# | Database           |
# +--------------------+
# | xiaozhi_esp32_server |
# | mysql              |
# | ...                |
# +--------------------+
```

**期望结果**：
- ✅ MySQL版本为8.0.x（不是9.x）
- ✅ 容器正常启动，状态为healthy
- ✅ 日志中没有配置参数错误
- ✅ 数据库连接正常
- ✅ `xiaozhi_esp32_server`数据库已创建

---

## 🎯 综合验证脚本

创建一个一键验证脚本：

```bash
#!/bin/bash
# 文件名：verify-optimization.sh

echo "========================================"
echo "  离线打包方案优化验证工具"
echo "========================================"
echo ""

cd ~/xiaozhi-esp32-server/xiaozhi-offline-deployment-*/

# 验证1：Sherpa模型
echo "【验证1】Sherpa ASR模型支持"
echo "----------------------------------------"
if [ -d "models/sherpa-onnx-sense-voice-zh-en-ja-ko-yue-2024-07-17" ]; then
    echo "✅ 宿主机Sherpa模型目录存在"
    if sudo docker exec xiaozhi-esp32-server ls /opt/xiaozhi-esp32-server/models/sherpa-onnx-sense-voice-zh-en-ja-ko-yue-2024-07-17/ &>/dev/null; then
        echo "✅ 容器内Sherpa模型挂载成功"
    else
        echo "❌ 容器内Sherpa模型挂载失败"
    fi
else
    echo "❌ 宿主机Sherpa模型目录不存在"
fi
echo ""

# 验证2：资源限制
echo "【验证2】资源限制移除"
echo "----------------------------------------"
deploy_lines=$(grep -n "deploy:" docker-compose-offline.yml | grep -v "^#" | wc -l)
if [ "$deploy_lines" -eq 0 ]; then
    echo "✅ docker-compose配置中所有资源限制已注释"
else
    echo "⚠️  docker-compose配置中仍有${deploy_lines}处未注释的资源限制"
fi

memory_limit=$(sudo docker inspect xiaozhi-esp32-server | jq '.[0].HostConfig.Memory')
if [ "$memory_limit" = "0" ]; then
    echo "✅ xiaozhi-esp32-server容器无内存限制"
else
    echo "⚠️  xiaozhi-esp32-server容器有内存限制: $memory_limit"
fi
echo ""

# 验证3：MySQL版本
echo "【验证3】MySQL版本"
echo "----------------------------------------"
mysql_image=$(grep -A 5 "xiaozhi-esp32-server-db:" docker-compose-offline.yml | grep "image:" | awk '{print $2}')
echo "配置的MySQL镜像: $mysql_image"

mysql_version=$(sudo docker exec xiaozhi-esp32-server-db mysql -V 2>/dev/null | grep -oP '\d+\.\d+\.\d+' | head -1)
if [ -n "$mysql_version" ]; then
    echo "运行的MySQL版本: $mysql_version"
    if echo "$mysql_version" | grep -q "^8\.0"; then
        echo "✅ MySQL版本正确（8.0.x）"
    else
        echo "⚠️  MySQL版本异常: $mysql_version"
    fi
else
    echo "❌ 无法获取MySQL版本（容器可能未运行）"
fi

mysql_error=$(sudo docker logs xiaozhi-esp32-server-db 2>&1 | grep "unknown variable" | tail -1)
if [ -z "$mysql_error" ]; then
    echo "✅ MySQL日志中无配置错误"
else
    echo "❌ MySQL日志中有配置错误:"
    echo "   $mysql_error"
fi
echo ""

# 总结
echo "========================================"
echo "  验证完成"
echo "========================================"
echo ""
echo "如需查看详细资源使用情况，运行："
echo "  sudo docker stats"
echo ""
echo "如需查看MySQL完整日志，运行："
echo "  sudo docker logs xiaozhi-esp32-server-db"
echo ""
```

**使用方法**：
```bash
# 在服务器上保存脚本
cat > verify-optimization.sh << 'EOF'
（复制上面的脚本内容）
EOF

# 添加执行权限
chmod +x verify-optimization.sh

# 运行验证
./verify-optimization.sh
```

---

## 📊 验证结果示例

### ✅ 成功案例

```
========================================
  离线打包方案优化验证工具
========================================

【验证1】Sherpa ASR模型支持
----------------------------------------
✅ 宿主机Sherpa模型目录存在
✅ 容器内Sherpa模型挂载成功

【验证2】资源限制移除
----------------------------------------
✅ docker-compose配置中所有资源限制已注释
✅ xiaozhi-esp32-server容器无内存限制

【验证3】MySQL版本
----------------------------------------
配置的MySQL镜像: mysql:8.0
运行的MySQL版本: 8.0.40
✅ MySQL版本正确（8.0.x）
✅ MySQL日志中无配置错误

========================================
  验证完成
========================================
```

### ❌ 失败案例及处理

#### 案例1：Sherpa模型挂载失败

```
❌ 容器内Sherpa模型挂载失败
```

**处理方法**：
```bash
# 检查宿主机models目录
ls -la models/

# 重启容器
sudo docker-compose -f docker-compose-offline.yml restart xiaozhi-esp32-server

# 再次验证
sudo docker exec xiaozhi-esp32-server ls /opt/xiaozhi-esp32-server/models/
```

#### 案例2：仍有资源限制

```
⚠️  docker-compose配置中仍有3处未注释的资源限制
```

**处理方法**：
```bash
# 编辑配置文件
vi docker-compose-offline.yml

# 搜索并注释所有deploy部分
# 找到 "deploy:" 开头的行，在前面加 #

# 重新加载配置
sudo docker-compose -f docker-compose-offline.yml up -d
```

#### 案例3：MySQL版本错误

```
⚠️  MySQL版本异常: 9.5.0
❌ MySQL日志中有配置错误:
   [ERROR] [MY-000067] [Server] unknown variable 'innodb_log_file_size=128M'
```

**处理方法**：
参考之前的「MySQL数据库问题修复指南」进行修复。

---

## ✅ 验证通过标准

所有三项验证都通过后，您的优化方案已成功部署：

1. ✅ **Sherpa模型**：
   - 宿主机有Sherpa模型目录
   - 容器内能访问Sherpa模型文件
   - 智控台可以选择并使用Sherpa ASR

2. ✅ **资源限制**：
   - docker-compose配置中所有deploy资源限制已注释
   - 容器inspect显示内存/CPU限制为0
   - docker stats显示资源使用动态变化

3. ✅ **MySQL版本**：
   - 镜像版本为mysql:8.0
   - 运行版本为8.0.x
   - 日志中无配置参数错误
   - 容器状态为healthy
   - 数据库正常连接

---

## 🎉 验证完成后

恭喜！优化方案已成功部署。接下来您可以：

1. **性能测试**：
   - 测试语音识别速度和准确率
   - 测试LLM响应时间
   - 测试TTS生成质量

2. **资源监控**：
   - 持续监控资源使用情况
   - 记录峰值和平均值
   - 为后期优化提供数据支持

3. **功能验证**：
   - 测试所有小智设备功能
   - 验证智能家居集成
   - 确认所有模型正常工作

如有任何问题，请参考「离线打包方案优化说明.md」或随时反馈！

