# 温度负载率工具函数 - 预设参数功能说明

## 🎯 功能概述

为了提升用户体验和演示流程的流畅性，新增了**自动使用预设推荐参数**功能。当用户不确定具体参数值，或希望快速完成演示时，系统可以自动填充预设的推荐参数，确保流程顺利进行。

## ✨ 新增功能

### 1. 预设参数自动填充

当用户说以下任何一种表达时，系统会自动使用预设的推荐参数：
- "随便设置"
- "帮我设置"
- "用推荐值"
- "使用默认值"
- "不知道设什么"
- "你帮我设置吧"
- 其他类似表达

### 2. 预设参数值

系统预设了两组推荐参数（优先使用第一组）：

| 温度 | 负载率 | 响应速度 | 说明 |
|------|--------|----------|------|
| 22.5℃ | 90kw | ⚡ 毫秒级 | 默认推荐值（最常用）|
| 28℃ | 95.6kw | ⚡ 毫秒级 | 备选推荐值 |

### 3. 智能补充

- 如果用户只提供了温度，缺少负载率 → 可以说"使用推荐值"来补充负载率
- 如果用户只提供了负载率，缺少温度 → 可以说"使用推荐值"来补充温度
- 如果用户两个参数都没提供 → 可以说"使用推荐值"来设置完整参数

## 🗣️ 使用示例

### 示例1：完全使用预设参数

```
👤 用户："设置温度和负载率"
🤖 小智："好的，请问您想设置的温度和负载率是多少？
        如果不确定设什么值，可以说'使用推荐值'或'帮我设置'，
        系统将使用预设的推荐参数。"
👤 用户："帮我设置吧"
🤖 小智："好的，已为您设置推荐参数：
        温度：22.5℃
        负载率：90kw
        请问这些参数是否确认？"
👤 用户："确认"
[系统调用API1和API2...]
🤖 小智："参数已确认。是否使用AI推荐模式进行节能优化？"
👤 用户："确认"
🤖 小智："✅ 已确认使用AI推荐模式，开始AI节能优化..."
```

### 示例2：用户提供温度，系统补充负载率

```
👤 用户："设置温度25度"
🤖 小智："温度已设置为25℃。请问负载率是多少千瓦？
        如果不确定负载率设什么值，可以说'使用推荐值'或'帮我设置'。"
👤 用户："用推荐值"
🤖 小智："好的，已为您设置推荐参数：
        温度：25℃
        负载率：90kw
        请问这些参数是否确认？"
... [后续流程]
```

### 示例3：用户提供负载率，系统补充温度

```
👤 用户："负载率设置为85千瓦"
🤖 小智："负载率已设置为85kw。请问温度是多少度？
        如果不确定温度设什么值，可以说'使用推荐值'或'帮我设置'。"
👤 用户："随便设置"
🤖 小智："好的，已为您设置推荐参数：
        温度：22.5℃
        负载率：85kw
        请问这些参数是否确认？"
... [后续流程]
```

### 示例4：快速演示模式

```
👤 用户："开始节能优化"
🤖 小智："好的，请问温度和负载率是多少？
        如果不确定设什么值，可以说'使用推荐值'..."
👤 用户："使用默认值"
🤖 小智："已为您设置推荐参数：温度22.5℃，负载率90kw，是否确认？"
👤 用户："确认"
[快速完成两轮确认...]
🤖 小智："✅ 已确认使用AI推荐模式，开始AI节能优化..."
```

## 📊 完整流程（使用预设参数）

```
用户："设置温度和负载率"
    ↓
系统："请问温度和负载率是多少？可以说'使用推荐值'..."
    ↓
用户："帮我设置" (触发 use_preset=True)
    ↓
【使用预设参数】检测到用户请求使用推荐参数
    ↓
【使用预设参数】温度设置为：22.5℃
【使用预设参数】负载率设置为：90kw
    ↓
状态更新为：waiting_first_confirm
    ↓
系统："已为您设置推荐参数：温度22.5℃，负载率90kw，是否确认？"
    ↓
用户："确认" (第一次确认)
    ↓
【第一次确认-步骤1】调用 API1 (毫秒级响应)
【第一次确认-步骤2】调用 API2 (stage=1)
    ↓
系统："参数已确认。是否使用AI推荐模式？"
    ↓
用户："确认" (第二次确认)
    ↓
【第二次确认】调用 API2 (stage=2)
    ↓
✅ 完成！
```

## 🔍 日志输出

使用预设参数时的关键日志：

```
================================================================================
【使用预设参数】用户请求使用预设推荐参数
================================================================================
【使用预设参数】推荐参数：温度=22.5℃, 负载率=90kw
【使用预设参数】✅ 温度已设置为预设值: 22.5℃
【使用预设参数】✅ 负载率已设置为预设值: 90kw
【使用预设参数】参数设置完成，请求用户确认
```

如果用户已提供了部分参数：

```
【使用预设参数】温度已由用户提供: 25℃
【使用预设参数】✅ 负载率已设置为预设值: 90kw
```

## 🎯 关键优势

### 1. 演示流畅性
- ✅ 避免用户卡在参数设置环节
- ✅ 快速完成演示流程
- ✅ 使用预设参数可获得毫秒级响应

### 2. 用户友好性
- ✅ 不需要用户了解具体参数值
- ✅ 提供智能提示和引导
- ✅ 支持多种自然语言表达

### 3. 灵活性
- ✅ 支持完全使用预设参数
- ✅ 支持部分使用预设参数
- ✅ 支持用户自定义参数
- ✅ 可随时切换使用预设值

## 💡 使用建议

### 演示场景
在演示或培训场景下，推荐直接使用预设参数：
```
"帮我设置温度和负载率" → 快速使用推荐值 → 快速完成演示
```

### 实际应用场景
在实际应用中，用户可以：
1. 提供精确参数值（如果知道）
2. 提供部分参数，其余使用推荐值
3. 完全使用推荐值，然后根据效果调整

## 🔧 技术实现

### 1. 函数签名更新
```python
def get_temperature_load_rate(
    conn, 
    temperature: str = None, 
    load_rate: str = None, 
    use_preset: bool = False,  # 新增参数
    confirm: bool = False, 
    cancel: bool = False
):
```

### 2. 预设参数定义
```python
PRESET_PARAMS = [
    {"temperature": 22.5, "load_rate": 90.0},   # 默认推荐值
    {"temperature": 28.0, "load_rate": 95.6},   # 备选推荐值
]
```

### 3. 智能填充逻辑
```python
if use_preset:
    preset = PRESET_PARAMS[0]  # 使用第一组推荐值
    
    # 智能填充缺失的参数
    if state["temperature"] is None:
        state["temperature_raw"] = preset["temperature"]
        state["temperature"] = f"{preset['temperature']}℃"
    
    if state["load_rate"] is None:
        state["load_rate_raw"] = preset["load_rate"]
        state["load_rate"] = f"{preset['load_rate']}kw"
```

### 4. LLM识别触发词
函数描述中明确说明触发条件：
```
"如果用户不知道设什么值，或说'随便设置'、'帮我设置'、'用推荐值'、
'默认值'等，则使用预设的推荐参数。"
```

## 📝 提示词优化

系统在各个阶段都会提示用户可以使用预设值：

1. **初始询问时**：
   > "可以一起提供或分别提供。同时提示用户：如果不确定设什么值，可以说'使用推荐值'或'帮我设置'，系统将使用预设的推荐参数"

2. **只有温度时**：
   > "同时提示：如果不确定负载率设什么值，可以说'使用推荐值'或'帮我设置'"

3. **只有负载率时**：
   > "同时提示：如果不确定温度设什么值，可以说'使用推荐值'或'帮我设置'"

## ✅ 测试验证

### 测试场景1：完全使用预设
```bash
用户输入："帮我设置温度和负载率"
预期结果：✅ 自动设置为 22.5℃ 和 90kw
```

### 测试场景2：部分使用预设（温度）
```bash
用户输入："负载率85千瓦" → "温度用推荐值"
预期结果：✅ 温度设置为 22.5℃，负载率保持 85kw
```

### 测试场景3：部分使用预设（负载率）
```bash
用户输入："温度28度" → "负载率随便设置"
预期结果：✅ 温度保持 28℃，负载率设置为 90kw
```

### 测试场景4：快速演示流程
```bash
用户输入："节能优化" → "使用默认值" → "确认" → "确认"
预期结果：✅ 全程流畅，快速完成两轮确认
```

## 🔄 版本信息

- **版本**：v2.2 - 预设参数功能
- **更新日期**：2025年10月16日
- **主要改进**：
  - ✅ 新增 `use_preset` 参数
  - ✅ 支持自动填充预设参数
  - ✅ 支持部分参数使用预设值
  - ✅ 优化用户提示信息
  - ✅ 增强演示流程流畅性

## 📚 相关文档

- 主函数：`main/xiaozhi-server/plugins_func/functions/get_temperature_load_rate.py`
- 流程优化说明：`温度负载率工具函数-流程优化说明.md`
- API集成文档：`docs/get_temperature_load_rate_api_integration.md`
- 使用说明：`温度负载率工具函数使用说明.md`

## 🎉 总结

通过新增预设参数功能，温度负载率工具函数现在可以：
- ✅ 自动处理用户不确定参数值的情况
- ✅ 确保演示流程始终流畅完整
- ✅ 提供更好的用户体验
- ✅ 支持快速演示和实际应用两种场景

**现在，每次演示都能顺利完成，不会因为参数问题而中断！** 🚀

---

**祝演示成功！** 🎊

