# get_temperature_humidity 工具函数使用说明

## 功能简介

`get_temperature_humidity` 是一个支持多轮对话交互的工具函数，用于从用户处获取并确认温度和湿度参数。该函数通过智能对话引导，确保用户提供完整且准确的参数。

## 核心特性

✅ **多轮对话支持** - 用户可以分步提供参数，系统会智能引导  
✅ **灵活输入方式** - 支持多种自然语言表达  
✅ **参数确认机制** - 避免误操作，确保参数正确  
✅ **参数验证** - 自动验证温度和湿度是否在合理范围内  
✅ **支持修改** - 确认前可随时修改参数  
✅ **取消操作** - 支持随时取消设置  

## 使用场景

该函数适用于以下场景：

1. **空调控制** - 设置目标温度和湿度
2. **环境监测** - 配置温湿度报警阈值
3. **智能家居** - 调整加湿器、除湿器参数
4. **其他需要温湿度输入的场景**

## 对话示例

### 示例1：一次性提供所有参数

```
👤 用户: "设置温度22度，湿度60%"
🤖 系统: "好的，您想设置温度为22℃，湿度为60%，请确认是否正确？"
👤 用户: "确认"
🤖 系统: {"temperature": "22℃", "humidity": "60%", "confirm": true}
```

### 示例2：分步提供参数

```
👤 用户: "我要设置温湿度"
🤖 系统: "好的，请告诉我您想设置的温度和湿度值"
👤 用户: "温度22度"
🤖 系统: "温度已设置为22℃，请告诉我湿度值"
👤 用户: "湿度60%"
🤖 系统: "好的，温度为22℃，湿度为60%，请确认是否正确？"
👤 用户: "确认"
🤖 系统: {"temperature": "22℃", "humidity": "60%", "confirm": true}
```

### 示例3：修改参数

```
👤 用户: "设置温度25度，湿度70%"
🤖 系统: "温度为25℃，湿度为70%，请确认是否正确？"
👤 用户: "温度改成22度"
🤖 系统: "已修改，温度为22℃，湿度为70%，请确认是否正确？"
👤 用户: "好的"
🤖 系统: {"temperature": "22℃", "humidity": "70%", "confirm": true}
```

### 示例4：取消操作

```
👤 用户: "设置温度20度"
🤖 系统: "温度已设置为20℃，请告诉我湿度值"
👤 用户: "取消"
🤖 系统: "好的，已取消温湿度设置"
```

### 示例5：参数验证

```
👤 用户: "设置温度100度"
🤖 系统: "温度100℃超出合理范围（-10℃~50℃），请重新输入"
👤 用户: "温度22度"
🤖 系统: "温度已设置为22℃，请告诉我湿度值"
```

## 支持的输入格式

### 温度格式

| 输入示例 | 识别结果 |
|---------|---------|
| 22度 | 22℃ |
| 22℃ | 22℃ |
| 22摄氏度 | 22℃ |
| 22.5度 | 22.5℃ |
| -5度 | -5℃ |

### 湿度格式

| 输入示例 | 识别结果 |
|---------|---------|
| 60% | 60% |
| 60 | 60% |
| 0.6 | 60% |

### 确认/取消关键词

**确认**: 确认、好的、是的、对的、没错、OK、可以  
**取消**: 取消、算了、不要了、放弃

## 参数范围限制

- **温度范围**: -10℃ ~ 50℃
- **湿度范围**: 0% ~ 100%

超出范围的参数会被系统拒绝，并提示用户重新输入。

## 返回格式

### 成功返回（已确认）

```json
{
    "temperature": "22℃",
    "humidity": "60%",
    "confirm": true
}
```

### 字段说明

- `temperature` (string): 格式化的温度值，包含单位
- `humidity` (string): 格式化的湿度值，包含百分号
- `confirm` (boolean): 用户确认标志，始终为 true

## 状态管理

函数使用 `conn.temp_humidity_setting` 存储会话状态，包含以下字段：

```python
{
    "temperature": "22℃",        # 格式化的温度
    "temperature_raw": 22.0,     # 原始温度数值
    "humidity": "60%",           # 格式化的湿度
    "humidity_raw": 60.0,        # 原始湿度数值
    "stage": "confirming"        # 当前阶段
}
```

状态在以下情况会被清除：
- ✅ 用户确认并成功返回结果
- ❌ 用户取消操作
- ⚠️ 发生错误

## 配置（可选）

如需自定义参数范围，可以在 `config.yaml` 中添加配置：

```yaml
plugins:
  get_temperature_humidity:
    enable: true
    temperature_range:
      min: -10
      max: 50
    humidity_range:
      min: 0
      max: 100
```

## 集成示例

### 在其他函数中使用返回的参数

```python
# 假设空调控制函数
def control_air_conditioner(conn, params_json):
    """使用温湿度参数控制空调"""
    params = json.loads(params_json)
    
    if params.get("confirm"):
        temperature = params.get("temperature")  # "22℃"
        humidity = params.get("humidity")        # "60%"
        
        # 提取数值
        temp_value = float(temperature.replace("℃", ""))
        humidity_value = float(humidity.replace("%", ""))
        
        # 执行空调控制逻辑
        # ...
```

## 常见问题

### Q1: 用户提供了温度但未提供湿度，系统会怎么处理？

A: 系统会记录已提供的温度，然后友好地询问用户提供湿度值。用户可以在后续对话中补充。

### Q2: 用户可以修改已输入的参数吗？

A: 可以。在确认之前，用户随时可以说"温度改成XX度"或"湿度改成XX%"来修改参数。

### Q3: 如果用户输入了超出范围的值会怎样？

A: 系统会拒绝该值，并提示用户输入的值超出合理范围（-10℃~50℃ 或 0%~100%），引导用户重新输入。

### Q4: 函数如何知道用户是在确认还是修改参数？

A: LLM会智能分析用户的意图：
- 确认意图："确认"、"好的"、"是的" → `confirm=True`
- 修改意图："温度改成25度" → 提取新的温度值
- 取消意图："取消"、"算了" → `cancel=True`

### Q5: 支持哪些语言？

A: 目前主要支持中文。温度和湿度的数值格式是通用的。

### Q6: 会话超时怎么办？

A: 当前版本没有超时机制。如需实现，可以在状态中添加时间戳，并在函数开始时检查是否超时。

## 技术细节

### 注册信息

- **函数名**: `get_temperature_humidity`
- **工具类型**: `ToolType.SYSTEM_CTL`
- **需要conn参数**: 是
- **支持流式输出**: 是（通过 `Action.REQLLM`）

### 主要函数

| 函数名 | 功能 |
|-------|------|
| `get_temperature_humidity()` | 主函数，处理参数收集和确认 |
| `parse_temperature()` | 解析温度字符串 |
| `parse_humidity()` | 解析湿度字符串 |
| `validate_temperature()` | 验证温度范围 |
| `validate_humidity()` | 验证湿度范围 |
| `initialize_temp_humidity_state()` | 初始化状态 |
| `clear_temp_humidity_state()` | 清除状态 |

## 版本信息

- **当前版本**: v1.0.0
- **创建日期**: 2024-10-09
- **兼容版本**: xiaozhi-esp32-server main分支

## 相关文档

- [开发文档](./get_temperature_humidity_development.md) - 详细的技术实现文档
- [项目README](../README.md) - 项目整体说明

## 支持与反馈

如有问题或建议，请提交Issue或PR。

