# å°æ™ºESP32æœåŠ¡å™¨ - ç¦»çº¿éƒ¨ç½²æ–‡æ¡£æ€»è§ˆ

> ğŸ“¦ å®Œæ•´çš„ç¦»çº¿éƒ¨ç½²è§£å†³æ–¹æ¡ˆï¼Œå¸®åŠ©æ‚¨å°†é¡¹ç›®é¡ºåˆ©è¿ç§»åˆ°ç¦»çº¿CentOSç¯å¢ƒ

---

## ğŸ“š æ–‡æ¡£å¯¼èˆª

### ğŸš€ å¿«é€Ÿå¼€å§‹

å¦‚æœæ‚¨æ˜¯ç¬¬ä¸€æ¬¡éƒ¨ç½²ï¼Œå»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºé˜…è¯»ï¼š

1. **[å¿«é€Ÿéƒ¨ç½²æŒ‡å—](offline-deployment-quickstart.md)** â­ æ¨è
   - 5åˆ†é’Ÿå¿«é€Ÿéƒ¨ç½²
   - æœ€ç²¾ç®€çš„æ­¥éª¤è¯´æ˜
   - å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

2. **[éƒ¨ç½²æ£€æŸ¥æ¸…å•](offline-deployment-checklist.md)**
   - å®Œæ•´çš„æ£€æŸ¥é¡¹ç›®
   - ç¡®ä¿ä¸é—æ¼ä»»ä½•æ­¥éª¤
   - å¯æ‰“å°ä½¿ç”¨

### ğŸ“– è¯¦ç»†æ–‡æ¡£

3. **[å®Œæ•´éƒ¨ç½²æŒ‡å—](offline-deployment-guide.md)**
   - æœ€è¯¦ç»†çš„éƒ¨ç½²è¯´æ˜
   - åŒ…å«æ‰€æœ‰é…ç½®ç»†èŠ‚
   - æ•…éšœæ’æŸ¥åŸºç¡€æŒ‡å—
   - æœåŠ¡ç®¡ç†å’Œç»´æŠ¤

4. **[æ•…éšœæ’æŸ¥æ‰‹å†Œ](offline-deployment-troubleshooting.md)**
   - å¸¸è§é—®é¢˜è¯¦ç»†è§£å†³æ–¹æ¡ˆ
   - ç³»ç»Ÿè¯Šæ–­æ–¹æ³•
   - æ€§èƒ½ä¼˜åŒ–å»ºè®®
   - æ•°æ®æ¢å¤æ–¹æ¡ˆ

### ğŸ› ï¸ è„šæœ¬å·¥å…·

5. **[è„šæœ¬ä½¿ç”¨è¯´æ˜](../scripts/README.md)**
   - æ‰€æœ‰è„šæœ¬çš„è¯¦ç»†è¯´æ˜
   - ä½¿ç”¨æ–¹æ³•å’Œç¤ºä¾‹
   - æ•…éšœæ’æŸ¥æŠ€å·§

---

## ğŸ“¦ æ–‡ä»¶ç»“æ„

```
xiaozhi-offline-deployment/
â”œâ”€â”€ images/                          # Dockeré•œåƒæ–‡ä»¶
â”‚   â”œâ”€â”€ server.tar                   # PythonæœåŠ¡é•œåƒ
â”‚   â”œâ”€â”€ web.tar                      # Webç®¡ç†é•œåƒ
â”‚   â”œâ”€â”€ mysql.tar                    # MySQLé•œåƒ
â”‚   â”œâ”€â”€ redis.tar                    # Redisé•œåƒ
â”‚   â””â”€â”€ checksums.md5                # æ ¡éªŒå’Œæ–‡ä»¶
â”‚
â”œâ”€â”€ scripts/                         # è¿ç»´è„šæœ¬
â”‚   â”œâ”€â”€ backup.sh                    # æ•°æ®å¤‡ä»½è„šæœ¬
â”‚   â””â”€â”€ README.md                    # è„šæœ¬è¯´æ˜æ–‡æ¡£
â”‚
â”œâ”€â”€ data/                            # åº”ç”¨é…ç½®ç›®å½•
â”‚   â”œâ”€â”€ config.yaml                  # ä¸»é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ config_from_api.yaml         # APIé…ç½®
â”‚
â”œâ”€â”€ mysql/                           # MySQLæ•°æ®ç›®å½•
â”‚   â””â”€â”€ data/                        # æ•°æ®åº“æ–‡ä»¶
â”‚
â”œâ”€â”€ uploadfile/                      # ä¸Šä¼ æ–‡ä»¶ç›®å½•
â”‚
â”œâ”€â”€ models/                          # AIæ¨¡å‹ç›®å½•
â”‚   â””â”€â”€ SenseVoiceSmall/
â”‚       â””â”€â”€ model.pt                 # è¯­éŸ³è¯†åˆ«æ¨¡å‹
â”‚
â”œâ”€â”€ docker-compose-offline.yml       # Docker Composeé…ç½®
â”œâ”€â”€ offline-deploy.sh                # è‡ªåŠ¨éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ install-docker-centos.sh         # Dockerå®‰è£…è„šæœ¬
â”‚
â”œâ”€â”€ offline-deployment-guide.md      # å®Œæ•´éƒ¨ç½²æŒ‡å—
â”œâ”€â”€ offline-deployment-quickstart.md # å¿«é€Ÿéƒ¨ç½²æŒ‡å—
â”œâ”€â”€ offline-deployment-checklist.md  # éƒ¨ç½²æ£€æŸ¥æ¸…å•
â”œâ”€â”€ offline-deployment-troubleshooting.md # æ•…éšœæ’æŸ¥æ‰‹å†Œ
â”œâ”€â”€ DEPLOYMENT-MANIFEST.txt          # éƒ¨ç½²æ¸…å•
â””â”€â”€ README.txt                       # å¿«é€Ÿè¯´æ˜
```

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯ä¸€ï¼šå…¨æ–°éƒ¨ç½²

**ç›®æ ‡**: åœ¨ä¸€å°å…¨æ–°çš„CentOSæœåŠ¡å™¨ä¸Šéƒ¨ç½²

**æ­¥éª¤**:
1. ä¼ è¾“éƒ¨ç½²åŒ…åˆ°æœåŠ¡å™¨
2. è§£å‹éƒ¨ç½²åŒ…
3. æ‰§è¡Œ `install-docker-centos.sh`
4. æ‰§è¡Œ `offline-deploy.sh`
5. è®¿é—®Webç•Œé¢éªŒè¯

**å‚è€ƒæ–‡æ¡£**: [å¿«é€Ÿéƒ¨ç½²æŒ‡å—](offline-deployment-quickstart.md)

---

### åœºæ™¯äºŒï¼šå¼€å‘ç¯å¢ƒæ‰“åŒ…

**ç›®æ ‡**: åœ¨å¼€å‘æœºå™¨ä¸Šæ‰“åŒ…æœ€æ–°ä»£ç 

**æ­¥éª¤**:
1. ç¡®ä¿æ‰€æœ‰ä»£ç å·²æäº¤
2. è¿è¡Œæ‰“åŒ…è„šæœ¬
   - Windows: `.\scripts\offline-package.ps1`
   - Linux/Mac: `./scripts/offline-package.sh`
3. è·å¾—å‹ç¼©åŒ…

**å‚è€ƒæ–‡æ¡£**: [è„šæœ¬ä½¿ç”¨è¯´æ˜](../scripts/README.md)

---

### åœºæ™¯ä¸‰ï¼šç‰ˆæœ¬å‡çº§

**ç›®æ ‡**: åœ¨å·²éƒ¨ç½²çš„æœåŠ¡å™¨ä¸Šå‡çº§åˆ°æ–°ç‰ˆæœ¬

**æ­¥éª¤**:
1. å¤‡ä»½ç°æœ‰æ•°æ® (`scripts/backup.sh`)
2. ä¼ è¾“æ–°ç‰ˆæœ¬éƒ¨ç½²åŒ…
3. åœæ­¢æ—§ç‰ˆæœ¬æœåŠ¡
4. åŠ è½½æ–°ç‰ˆæœ¬é•œåƒ
5. å¯åŠ¨æ–°ç‰ˆæœ¬æœåŠ¡
6. éªŒè¯åŠŸèƒ½

**å‚è€ƒæ–‡æ¡£**: [å®Œæ•´éƒ¨ç½²æŒ‡å— - å‡çº§ä¸ç»´æŠ¤](offline-deployment-guide.md#å…«å‡çº§ä¸ç»´æŠ¤)

---

### åœºæ™¯å››ï¼šæ•…éšœæ’æŸ¥

**ç›®æ ‡**: è§£å†³éƒ¨ç½²æˆ–è¿è¡Œæ—¶é—®é¢˜

**æ­¥éª¤**:
1. è¯†åˆ«é—®é¢˜ç°è±¡
2. æŸ¥çœ‹[æ•…éšœæ’æŸ¥æ‰‹å†Œ](offline-deployment-troubleshooting.md)
3. æŒ‰ç…§å¯¹åº”ç« èŠ‚æ’æŸ¥
4. æ”¶é›†ç³»ç»Ÿä¿¡æ¯ï¼ˆå¦‚éœ€å¸®åŠ©ï¼‰
5. è”ç³»æŠ€æœ¯æ”¯æŒ

**å‚è€ƒæ–‡æ¡£**: [æ•…éšœæ’æŸ¥æ‰‹å†Œ](offline-deployment-troubleshooting.md)

---

## ğŸ“ å­¦ä¹ è·¯å¾„

### åˆå­¦è€…

```
å¿«é€Ÿéƒ¨ç½²æŒ‡å— â†’ å®é™…æ“ä½œ â†’ é‡åˆ°é—®é¢˜æŸ¥æ•…éšœæ’æŸ¥æ‰‹å†Œ
```

### è¿ç»´äººå‘˜

```
å®Œæ•´éƒ¨ç½²æŒ‡å— â†’ éƒ¨ç½²æ£€æŸ¥æ¸…å• â†’ è„šæœ¬ä½¿ç”¨è¯´æ˜ â†’ æ•…éšœæ’æŸ¥æ‰‹å†Œ
```

### å¼€å‘äººå‘˜

```
è„šæœ¬ä½¿ç”¨è¯´æ˜ â†’ å®Œæ•´éƒ¨ç½²æŒ‡å— â†’ è‡ªå®šä¹‰ä¿®æ”¹ â†’ æ‰“åŒ…æµ‹è¯•
```

---

## âš¡ å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

### æœåŠ¡ç®¡ç†

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose-offline.yml up -d

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose-offline.yml down

# é‡å¯æœåŠ¡
docker-compose -f docker-compose-offline.yml restart

# æŸ¥çœ‹çŠ¶æ€
docker-compose -f docker-compose-offline.yml ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose-offline.yml logs -f
```

### å®¹å™¨æ“ä½œ

```bash
# è¿›å…¥serverå®¹å™¨
docker exec -it xiaozhi-esp32-server bash

# æŸ¥çœ‹serveræ—¥å¿—
docker logs -f xiaozhi-esp32-server

# é‡å¯å•ä¸ªå®¹å™¨
docker restart xiaozhi-esp32-server
```

### æ•°æ®å¤‡ä»½

```bash
# æ‰‹åŠ¨å¤‡ä»½
./scripts/backup.sh

# é…ç½®è‡ªåŠ¨å¤‡ä»½
crontab -e
# æ·»åŠ : 0 2 * * * /root/offline-package/scripts/backup.sh
```

### ç³»ç»Ÿè¯Šæ–­

```bash
# æ£€æŸ¥èµ„æºä½¿ç”¨
docker stats

# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h
docker system df

# æ£€æŸ¥ç½‘ç»œè¿æ¥
netstat -tlnp | grep -E "8000|8002|8003"

# æŸ¥çœ‹é˜²ç«å¢™
firewall-cmd --list-ports
```

---

## ğŸ”‘ å…³é”®é…ç½®æ–‡ä»¶

### docker-compose-offline.yml
DockeræœåŠ¡ç¼–æ’é…ç½®ï¼ŒåŒ…å«ï¼š
- é•œåƒåç§°å’Œæ ‡ç­¾
- ç«¯å£æ˜ å°„
- æ•°æ®å·æŒ‚è½½
- ç¯å¢ƒå˜é‡
- èµ„æºé™åˆ¶

**ä¿®æ”¹åéœ€è¦**: `docker-compose -f docker-compose-offline.yml up -d --force-recreate`

### data/config.yaml
åº”ç”¨ä¸»é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«ï¼š
- æœåŠ¡å™¨IPå’Œç«¯å£
- APIå¯†é’¥
- åŠŸèƒ½å¼€å…³
- å·¥å…·å‡½æ•°é…ç½®

**ä¿®æ”¹åéœ€è¦**: `docker-compose -f docker-compose-offline.yml restart xiaozhi-esp32-server`

---

## ğŸ“Š ç³»ç»Ÿè¦æ±‚

### æœ€ä½é…ç½®

| ç»„ä»¶ | è¦æ±‚ |
|------|------|
| æ“ä½œç³»ç»Ÿ | CentOS 7.x / 8.x / Stream |
| CPU | 4æ ¸å¿ƒ |
| å†…å­˜ | 8GB |
| ç£ç›˜ | 50GBå¯ç”¨ç©ºé—´ |
| Docker | 20.10+ |

### æ¨èé…ç½®

| ç»„ä»¶ | è¦æ±‚ |
|------|------|
| æ“ä½œç³»ç»Ÿ | CentOS 8 / Stream |
| CPU | 8æ ¸å¿ƒ+ |
| å†…å­˜ | 16GB+ |
| ç£ç›˜ | 100GB+ SSD |
| Docker | æœ€æ–°ç‰ˆæœ¬ |

---

## ğŸ” å®‰å…¨å»ºè®®

### å¿…é¡»ä¿®æ”¹çš„é»˜è®¤é…ç½®

```yaml
# 1. ä¿®æ”¹MySQLå¯†ç 
# docker-compose-offline.yml
environment:
  - MYSQL_ROOT_PASSWORD: ä½ çš„å¼ºå¯†ç 

# 2. ä¿®æ”¹ç®¡ç†å‘˜è´¦å·å¯†ç 
# ç™»å½•Webç•Œé¢åç«‹å³ä¿®æ”¹

# 3. é…ç½®é˜²ç«å¢™
firewall-cmd --permanent --add-rich-rule='
  rule family="ipv4" source address="å…è®¸çš„IPæ®µ"
  port protocol="tcp" port="8002" accept'

# 4. å¯ç”¨HTTPSï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
# é…ç½®Nginx SSLè¯ä¹¦
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### æ•°æ®åº“ä¼˜åŒ–

```yaml
# docker-compose-offline.yml MySQLéƒ¨åˆ†
command:
  - --max_connections=1000
  - --innodb_buffer_pool_size=2G  # è®¾ç½®ä¸ºæ€»å†…å­˜çš„50-70%
  - --innodb_log_file_size=256M
  - --query_cache_size=64M
```

### Redisä¼˜åŒ–

```yaml
command:
  - redis-server
  - --maxmemory 2gb
  - --maxmemory-policy allkeys-lru
```

### åº”ç”¨ä¼˜åŒ–

```yaml
# docker-compose-offline.yml serveréƒ¨åˆ†
deploy:
  resources:
    limits:
      cpus: '8'
      memory: 16G
```

---

## ğŸ“ è·å–æ”¯æŒ

### åœ¨çº¿èµ„æº

- **é¡¹ç›®ä¸»é¡µ**: https://github.com/xinnan-tech/xiaozhi-esp32-server
- **æ–‡æ¡£ä¸­å¿ƒ**: https://github.com/xinnan-tech/xiaozhi-esp32-server/tree/main/docs
- **é—®é¢˜åé¦ˆ**: https://github.com/xinnan-tech/xiaozhi-esp32-server/issues

### æäº¤é—®é¢˜æ—¶è¯·æä¾›

1. ç³»ç»Ÿä¿¡æ¯ï¼ˆOSç‰ˆæœ¬ã€Dockerç‰ˆæœ¬ï¼‰
2. éƒ¨ç½²åŒ…ç‰ˆæœ¬å’Œæ‰“åŒ…æ—¶é—´
3. é”™è¯¯ç°è±¡å’Œæ—¥å¿—
4. troubleshoot.logï¼ˆä½¿ç”¨æ•…éšœæ’æŸ¥æ‰‹å†Œä¸­çš„è„šæœ¬ç”Ÿæˆï¼‰

### ç¤¾åŒºæ”¯æŒ

- æŸ¥çœ‹å·²æœ‰çš„Issueå’Œè®¨è®º
- å‚è€ƒWikiæ–‡æ¡£
- å‚ä¸ç¤¾åŒºè®¨è®º

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0 (2024)

**æ–°åŠŸèƒ½**:
- âœ… å®Œæ•´çš„ç¦»çº¿éƒ¨ç½²æ–¹æ¡ˆ
- âœ… è‡ªåŠ¨åŒ–æ‰“åŒ…å’Œéƒ¨ç½²è„šæœ¬
- âœ… è¯¦ç»†çš„æ–‡æ¡£ä½“ç³»
- âœ… æ•…éšœæ’æŸ¥æŒ‡å—
- âœ… æ•°æ®å¤‡ä»½å’Œæ¢å¤æ–¹æ¡ˆ

**æ”¹è¿›**:
- âœ… ä¼˜åŒ–Dockeré•œåƒæ„å»º
- âœ… å¢åŠ èµ„æºé™åˆ¶é…ç½®
- âœ… é…ç½®æ—¥å¿—è½®è½¬
- âœ… æ·»åŠ å¥åº·æ£€æŸ¥

---

## âœ… éƒ¨ç½²æˆåŠŸæ ‡å¿—

å½“æ‚¨çœ‹åˆ°ä»¥ä¸‹ç°è±¡æ—¶ï¼Œè¯´æ˜éƒ¨ç½²æˆåŠŸï¼š

- âœ… 4ä¸ªå®¹å™¨éƒ½å¤„äºè¿è¡ŒçŠ¶æ€
- âœ… å¯ä»¥è®¿é—® http://æœåŠ¡å™¨IP:8002
- âœ… Webç•Œé¢æ­£å¸¸æ˜¾ç¤º
- âœ… å¯ä»¥æ­£å¸¸ç™»å½•ç®¡ç†åå°
- âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸
- âœ… å·¥å…·å‡½æ•°å¯ä»¥æ­£å¸¸è°ƒç”¨
- âœ… ESP32è®¾å¤‡å¯ä»¥è¿æ¥ï¼ˆå¦‚æœ‰ï¼‰

---

## ğŸ‰ ç»“è¯­

è¿™å¥—ç¦»çº¿éƒ¨ç½²æ–¹æ¡ˆç»è¿‡ç²¾å¿ƒè®¾è®¡å’Œæµ‹è¯•ï¼Œæ—¨åœ¨å¸®åŠ©æ‚¨ï¼š

- ğŸš€ **å¿«é€Ÿéƒ¨ç½²** - è‡ªåŠ¨åŒ–è„šæœ¬ç®€åŒ–æµç¨‹
- ğŸ›¡ï¸ **ç¨³å®šå¯é ** - å®Œæ•´çš„æ•…éšœå¤„ç†æ–¹æ¡ˆ
- ğŸ“š **æ–‡æ¡£å®Œå–„** - è¯¦ç»†çš„è¯´æ˜å’Œç¤ºä¾‹
- ğŸ”§ **æ˜“äºç»´æŠ¤** - è¿ç»´è„šæœ¬å’Œç›‘æ§æ–¹æ¡ˆ
- ğŸ†˜ **æŠ€æœ¯æ”¯æŒ** - å®Œæ•´çš„é—®é¢˜æ’æŸ¥æŒ‡å—

å¦‚æœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åé¦ˆï¼

**ç¥æ‚¨éƒ¨ç½²é¡ºåˆ©ï¼** ğŸŠ

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2024
**ç»´æŠ¤è€…**: Xinnan Tech

