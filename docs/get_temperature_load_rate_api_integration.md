# 温度负载率工具函数 - API集成开发文档

## 📋 概述

本文档详细说明了 `get_temperature_load_rate` 工具函数的API集成改造，实现了完整的递进式两轮确认流程，集成了外部API接口，用于启动AI节能优化。

## 🎯 功能特点

### 核心功能
1. **参数收集**：支持温度（℃）和负载率（kw）的智能识别和收集
2. **多轮对话**：用户可一次性或分步提供参数
3. **API集成**：
   - 接口1（/api/asr）：提交温度和负载率参数
   - 接口2（/api/confirm）：递进式两轮确认
4. **递进式确认**：
   - 第一轮确认：用户确认温度和负载率参数
   - 第二轮确认：用户确认是否使用AI推荐模式
5. **健壮性设计**：
   - 预设快速响应参数（毫秒级）
   - 超时保护（35秒）
   - 完整的错误处理
   - 任务冲突检测

## 🔧 API接口说明

### 接口1: /api/asr - 参数设置

**请求**：
```bash
curl --location 'http://10.100.193.243:9000/api/asr' \
--header 'Content-Type: application/json' \
--data '{
    "temperature": "22.5",
    "load_rate": "90"
}'
```

**参数说明**：
- `temperature`: 温度值（数值，不带单位），支持字符串或数字
- `load_rate`: 负载率值（单位：kw千瓦），支持字符串或数字

**成功响应**：
```json
{
    "status": "success",
    "message": {
        "type": "confirm_request",
        "temperature": 22.5,
        "load_rate": 90.0,
        "descripetion": "请确认是否设置参数"
    }
}
```

**快速响应（预设参数）**：
```json
{
    "status": "success",
    "source": "mock",
    "mock_folder": "example/temperature_load_rate_22.5_90.0",
    "message": {
        "type": "confirm_request",
        "temperature": 22.5,
        "load_rate": 90.0,
        "descripetion": "请确认是否设置参数"
    }
}
```

**失败响应（任务冲突）**：
```json
{
    "status": "fail",
    "error": "优化任务正在进行中，请稍后再试。",
    "code": 409
}
```

**预设快速响应参数**（毫秒级响应）：
- `{"temperature": 22.5, "load_rate": 90.0}`
- `{"temperature": 28.0, "load_rate": 95.6}`

### 接口2: /api/confirm - 确认操作

**请求**：
```bash
curl --location 'http://10.100.193.243:9000/api/confirm' \
--header 'Content-Type: application/json' \
--data '{ "status": 1 }'
```

**参数说明**：
- `status`: 1=确认, 0=取消

**第一次确认成功响应（stage=1）**：
```json
{
    "status": "success",
    "stage": 1,
    "message": {
        "type": "confirm",
        "stage": 1,
        "descripetion": "已确认设置参数"
    }
}
```

**第二次确认成功响应（stage=2）**：
```json
{
    "status": "success",
    "stage": 2,
    "message": {
        "type": "confirm",
        "stage": 2,
        "descripetion": "已确认使用AI推荐模式，开始AI节能优化"
    }
}
```

**取消响应**：
```json
{
    "status": "canceled",
    "message": "已取消本次操作"
}
```

**失败响应**：
```json
{
    "status": "fail",
    "message": "当前没有待确认的操作，请先进行温度或负载率设置"
}
```

## 🔄 完整交互流程

```
┌─────────────────────────────────────────┐
│ 1. 用户输入温度和负载率                      │
│    "设置温度22.5度，负载率90千瓦"             │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 2. 参数收集与验证                           │
│    - 解析温度：22.5℃                       │
│    - 解析负载率：90kw                       │
│    - 验证范围：-10~50℃, 0~200kw           │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 3. 调用接口1: /api/asr                    │
│    POST {"temperature": "22.5",          │
│          "load_rate": "90"}              │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 4. 第一次确认请求                           │
│    系统："您要设置温度22.5℃，负载率90kw，   │
│           请确认是否正确？"                  │
│    用户："确认"                             │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 5. 调用接口2（第一次）: /api/confirm       │
│    POST {"status": 1}                    │
│    响应：{"stage": 1, ...}                │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 6. 第二次确认请求                           │
│    系统："是否使用AI推荐模式进行节能优化？"   │
│    用户："好的"                             │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 7. 调用接口2（第二次）: /api/confirm       │
│    POST {"status": 1}                    │
│    响应：{"stage": 2, ...}                │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│ 8. 完成流程                                │
│    "✅ 已确认使用AI推荐模式，开始AI节能优化" │
│    "系统已启动AI节能优化流程"               │
└─────────────────────────────────────────┘
```

## 🎨 状态管理

函数使用 `conn.temp_load_rate_setting` 维护状态：

```python
{
    "temperature": "22.5℃",        # 格式化的温度字符串
    "temperature_raw": 22.5,        # 原始温度数值
    "load_rate": "90kw",           # 格式化的负载率字符串
    "load_rate_raw": 90.0,         # 原始负载率数值
    "stage": "init",               # 当前阶段
    "api1_response": {...},        # 接口1的响应数据
    "confirm_stage": 0,            # 确认阶段：0/1/2
}
```

### 阶段说明

| 阶段 | 说明 | 用户行为 |
|------|------|----------|
| `init` | 初始状态 | 开始设置 |
| `collecting` | 参数收集中 | 提供温度/负载率 |
| `api1_success` | API1调用成功 | - |
| `stage1_confirming` | 等待第一次确认 | 确认参数 |
| `stage1_success` | 第一次确认完成 | - |
| `stage2_confirming` | 等待第二次确认 | 确认AI模式 |
| `completed` | 流程完成 | - |

## ⚙️ 配置说明

在 `config.yaml` 的 `plugins` 部分添加配置：

```yaml
plugins:
  # ... 其他插件配置 ...
  
  get_temperature_load_rate:
    api_base_url: "http://10.100.193.243:9000"
```

**配置项说明**：
- `api_base_url`: API基础URL地址
  - 默认值：`http://10.100.193.243:9000`
  - 如果不配置，将使用代码中的默认值

## 📝 使用示例

### 示例1：一次性提供所有参数

**用户**："设置温度22.5度，负载率90千瓦"

**系统流程**：
1. 收集参数：22.5℃, 90kw
2. 调用接口1
3. 询问："您要设置温度22.5℃，负载率90kw，请确认是否正确？"

**用户**："确认"

**系统流程**：
4. 调用接口2（第一次）
5. 询问："是否使用AI推荐模式进行节能优化？"

**用户**："好的"

**系统流程**：
6. 调用接口2（第二次）
7. 回复："✅ 已确认使用AI推荐模式，开始AI节能优化"

### 示例2：分步提供参数

**用户**："设置温度"

**系统**："好的，请问您想设置的温度是多少度？"

**用户**："22.5度"

**系统**："温度已设置为22.5℃，请问负载率是多少千瓦？"

**用户**："90千瓦"

**系统流程**：
1. 调用接口1
2. 询问："您要设置温度22.5℃，负载率90kw，请确认是否正确？"

... (后续流程同示例1)

### 示例3：使用预设参数（快速响应）

**用户**："设置温度28度，负载率95.6千瓦"

**系统流程**：
1. 检测到预设参数 (28.0, 95.6)
2. 快速调用接口1（毫秒级响应）
3. 正常进行后续确认流程

### 示例4：取消操作

**用户**："设置温度22度，负载率90千瓦"

**系统**："您要设置温度22℃，负载率90kw，请确认是否正确？"

**用户**："取消"

**系统流程**：
1. 调用接口2，status=0
2. 清除状态
3. 回复："好的，已取消温度负载率设置"

## 🔍 错误处理

### 1. 参数范围错误

```
用户："设置温度100度"
系统："温度100℃超出合理范围（-10℃~50℃），请重新输入"
```

### 2. API调用超时

```
系统："接口调用超时，请稍后再试"
```

### 3. 任务冲突（409错误）

```
系统："优化任务正在进行中，请稍后再试"
```

### 4. 接口调用失败

```
系统："参数设置失败: [错误信息]"
```

### 5. 确认操作失败

```
系统："确认操作失败: 当前没有待确认的操作，请先进行温度或负载率设置"
```

## 🧪 测试建议

### 1. 基础功能测试
- [ ] 一次性提供两个参数
- [ ] 分步提供参数
- [ ] 参数格式变化（带单位/不带单位）
- [ ] 取消操作

### 2. API集成测试
- [ ] 预设参数快速响应
- [ ] 非预设参数正常响应
- [ ] 第一次确认流程
- [ ] 第二次确认流程
- [ ] 完整流程端到端测试

### 3. 异常情况测试
- [ ] 参数超出范围
- [ ] API调用超时
- [ ] 任务冲突（409）
- [ ] 网络错误
- [ ] 中途取消

### 4. 状态管理测试
- [ ] 状态正确初始化
- [ ] 状态正确更新
- [ ] 状态正确清除
- [ ] 多轮对话状态保持

## 📊 性能优化

### 预设参数优化
- 使用预设参数 `(22.5, 90.0)` 或 `(28.0, 95.6)` 可获得毫秒级响应
- 其他参数可能需要10-30秒处理时间
- 建议用户优先使用预设参数或接近预设的参数

### 超时设置
- API1（/api/asr）：35秒超时
- API2（/api/confirm）：10秒超时

## 🔐 安全性考虑

1. **参数验证**：严格验证温度和负载率范围
2. **状态隔离**：每个连接独立维护状态
3. **错误恢复**：异常情况自动清除状态
4. **超时保护**：防止长时间阻塞

## 📚 相关文件

- 主函数：`main/xiaozhi-server/plugins_func/functions/get_temperature_load_rate.py`
- 配置文件：`main/xiaozhi-server/config.yaml`
- 本文档：`docs/get_temperature_load_rate_api_integration.md`

## 🔄 版本历史

### v2.0 - API集成版本
- ✅ 集成外部API接口
- ✅ 实现递进式两轮确认
- ✅ 添加预设参数快速响应
- ✅ 完善错误处理和超时保护
- ✅ 负载率改为kw单位（而非百分比）

### v1.0 - 基础版本
- ✅ 基础参数收集功能
- ✅ 多轮对话支持
- ✅ 参数验证

## 🙏 致谢

感谢小智ESP32项目团队提供的优秀架构和工具函数框架！

