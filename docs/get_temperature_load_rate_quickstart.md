# 温度负载率工具函数 - 快速开始指南

## 🚀 快速开始

### 第一步：配置API地址

在 `main/xiaozhi-server/config.yaml` 的 `plugins` 部分添加配置：

```yaml
plugins:
  # 温度负载率API配置
  get_temperature_load_rate:
    api_base_url: "http://10.100.193.243:9000"
```

或者在 `data/.config.yaml` 中添加（推荐，保护密钥安全）：

```yaml
plugins:
  get_temperature_load_rate:
    api_base_url: "http://10.100.193.243:9000"  # 替换为你的实际API地址
```

### 第二步：验证API可用性

使用 curl 命令测试API是否可访问：

```bash
# 测试接口1
curl --location 'http://10.100.193.243:9000/api/asr' \
--header 'Content-Type: application/json' \
--data '{
    "temperature": "22.5",
    "load_rate": "90"
}'

# 测试接口2
curl --location 'http://10.100.193.243:9000/api/confirm' \
--header 'Content-Type: application/json' \
--data '{ "status": 1 }'
```

### 第三步：启动服务

```bash
cd main/xiaozhi-server
python app.py
```

### 第四步：开始使用

通过语音或文本与小智交互：

**推荐使用预设参数（毫秒级响应）**：

- "设置温度22.5度，负载率90千瓦"
- "设置温度28度，负载率95.6千瓦"

**自定义参数（10-30秒响应）**：

- "设置温度25度，负载率80千瓦"
- "调整温度和负载率"

## 💡 使用技巧

### 1. 推荐使用预设参数

为了获得最佳用户体验（毫秒级响应），建议使用以下预设参数：

| 温度 | 负载率 | 说法示例 |
|------|--------|----------|
| 22.5℃ | 90kw | "设置温度22.5度，负载率90千瓦" |
| 28℃ | 95.6kw | "设置温度28度，负载率95.6千瓦" |

### 2. 支持的说法

**温度**：
- "22.5度"
- "22.5℃"
- "22.5摄氏度"
- "二十二点五度"（需LLM转换）

**负载率**：
- "90千瓦"
- "90kw"
- "90"
- "九十千瓦"（需LLM转换）

### 3. 完整对话示例

#### 示例A：一次性输入（推荐）

```
用户："设置温度22.5度，负载率90千瓦"
小智："您要设置温度22.5℃，负载率90kw，请确认是否正确？"
用户："确认"
小智："好的，参数已确认。是否使用AI推荐模式进行节能优化？"
用户："是的"
小智："✅ 已确认使用AI推荐模式，开始AI节能优化
       温度: 22.5℃
       负载率: 90kw
       系统已启动AI节能优化流程"
```

#### 示例B：分步输入

```
用户："设置温度"
小智："好的，请问您想设置的温度是多少度？"
用户："22.5度"
小智："温度已设置为22.5℃，请问负载率是多少千瓦？"
用户："90千瓦"
小智："您要设置温度22.5℃，负载率90kw，请确认是否正确？"
用户："确认"
小智："好的，参数已确认。是否使用AI推荐模式进行节能优化？"
用户："好的"
小智："✅ 已确认使用AI推荐模式，开始AI节能优化..."
```

#### 示例C：中途取消

```
用户："设置温度22度，负载率90千瓦"
小智："您要设置温度22℃，负载率90kw，请确认是否正确？"
用户："取消"
小智："好的，已取消温度负载率设置"
```

## ⚠️ 常见问题

### Q1: 为什么我的设置很慢？

**A**: 如果不使用预设参数 (22.5, 90) 或 (28, 95.6)，API处理需要10-30秒。建议使用预设参数或接近预设的值。

### Q2: 提示"优化任务正在进行中"怎么办？

**A**: 说明后台正在执行其他优化任务，请等待几分钟后再次尝试。

### Q3: 负载率的单位是什么？

**A**: 负载率的单位是**千瓦(kw)**，不是百分比。例如："90千瓦"或"90kw"。

### Q4: 可以修改参数范围吗？

**A**: 可以。编辑 `get_temperature_load_rate.py`：
- 温度范围：`validate_temperature` 函数（默认 -10~50℃）
- 负载率范围：`validate_load_rate` 函数（默认 0~200kw）

### Q5: API地址怎么配置？

**A**: 
1. 方式1：修改 `config.yaml` 的 `plugins.get_temperature_load_rate.api_base_url`
2. 方式2：修改 `data/.config.yaml`（推荐）
3. 如果不配置，使用默认地址：`http://10.100.193.243:9000`

### Q6: 如何调试API调用？

**A**: 查看日志输出，搜索关键词：
- "调用ASR API" - 接口1调用
- "调用确认API" - 接口2调用
- "ASR API响应" - 接口1响应
- "确认API响应" - 接口2响应

## 🔍 故障排查

### 问题：提示"接口调用超时"

**可能原因**：
1. API服务未启动
2. 网络不通
3. 参数处理时间过长（超过35秒）

**解决方案**：
1. 检查API服务状态
2. 测试网络连通性：`ping 10.100.193.243`
3. 使用预设参数避免超时

### 问题：提示"接口调用失败"

**可能原因**：
1. API地址配置错误
2. 网络错误
3. API返回格式异常

**解决方案**：
1. 检查 `config.yaml` 中的 `api_base_url` 配置
2. 使用 curl 命令手动测试API
3. 查看详细错误日志

### 问题：提示"当前没有待确认的操作"

**可能原因**：
调用接口2时，前序步骤未完成（未调用接口1）

**解决方案**：
这是正常的流程控制，用户需要先设置温度和负载率参数。

## 📊 性能对比

| 参数类型 | 响应时间 | 说明 |
|---------|---------|------|
| 预设参数 (22.5, 90) | 毫秒级 | ⭐ 推荐使用 |
| 预设参数 (28, 95.6) | 毫秒级 | ⭐ 推荐使用 |
| 自定义参数 | 10-30秒 | 需要后台计算 |

## 📚 相关文档

- [详细开发文档](./get_temperature_load_rate_api_integration.md)
- [API接口文档](./get_temperature_load_rate_api_integration.md#api接口说明)
- [完整交互流程](./get_temperature_load_rate_api_integration.md#完整交互流程)

## 🆘 获取帮助

如遇到问题，请：
1. 查看日志输出
2. 阅读完整开发文档
3. 使用 curl 命令手动测试API
4. 提供详细的错误信息和日志

---

**祝您使用愉快！** 🎉

