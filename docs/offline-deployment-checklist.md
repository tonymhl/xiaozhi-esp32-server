# 小智ESP32服务器 - 离线部署检查清单

本检查清单帮助您确保离线部署过程的每个环节都正确完成。

---

## 📦 一、打包阶段（在线环境）

### 环境准备
- [ ] 确认Docker已安装并运行 (`docker --version`)
- [ ] 确认Docker Compose已安装 (`docker-compose --version`)
- [ ] 确认有足够的磁盘空间（至少20GB可用）
- [ ] 确认所有代码修改已提交 (`git status`)

### 代码准备
- [ ] 新增的工具函数已添加到项目中
- [ ] 工具函数代码已测试通过
- [ ] requirements.txt已更新（如有新依赖）
- [ ] 配置文件已按需修改

### 执行打包
- [ ] 下载或创建了打包脚本
  - Windows: `scripts/offline-package.ps1`
  - Linux/Mac: `scripts/offline-package.sh`
- [ ] 执行打包脚本成功
- [ ] 生成了压缩包文件
- [ ] 记录压缩包文件名和大小

### 验证打包结果
- [ ] 检查压缩包大小是否合理（预期3-8GB）
- [ ] 生成了MD5校验文件
- [ ] 检查DEPLOYMENT-MANIFEST.txt内容
- [ ] 确认包含所有4个镜像文件
  - [ ] server.tar
  - [ ] web.tar
  - [ ] mysql.tar
  - [ ] redis.tar

### 额外文件准备
- [ ] 准备模型文件（SenseVoiceSmall/model.pt）
- [ ] 准备自定义配置文件（如有）
- [ ] 准备其他必要的资源文件

---

## 📤 二、传输阶段

### 传输前准备
- [ ] 计算压缩包MD5值
- [ ] 记录文件信息到文档
- [ ] 准备传输介质（U盘/移动硬盘）或网络传输工具

### 文件传输
- [ ] 将压缩包传输到目标服务器
- [ ] 传输所有相关文档
- [ ] 传输校验文件

### 传输后验证
- [ ] 在目标服务器上验证文件完整性
- [ ] MD5校验通过
- [ ] 文件大小一致
- [ ] 文件可正常解压

---

## 🖥️ 三、离线部署阶段（目标CentOS服务器）

### 系统环境检查
- [ ] 操作系统版本确认（CentOS 7/8/Stream）
- [ ] 系统架构确认（x86_64）
- [ ] 内存容量检查（≥8GB）
- [ ] 磁盘空间检查（≥50GB可用）
- [ ] 网络配置检查（内网连接正常）

### Docker环境准备
- [ ] 检查Docker是否已安装
- [ ] 如未安装，执行 `install-docker-centos.sh`
- [ ] 验证Docker服务运行状态
- [ ] 验证Docker Compose安装
- [ ] 测试Docker基本功能

### 解压部署包
- [ ] 创建部署目录（如 /root/xiaozhi-deployment）
- [ ] 解压压缩包到部署目录
- [ ] 验证目录结构完整
- [ ] 检查所有必要文件存在

### 加载Docker镜像
- [ ] 验证镜像文件完整性（checksums.md5）
- [ ] 加载server镜像
- [ ] 加载web镜像
- [ ] 加载mysql镜像
- [ ] 加载redis镜像
- [ ] 验证所有镜像加载成功 (`docker images`)

### 配置修改
- [ ] 检查 docker-compose-offline.yml
- [ ] 修改端口映射（如有冲突）
- [ ] 修改数据库密码（生产环境建议修改）
- [ ] 检查 data/config.yaml
- [ ] 修改服务器IP地址
- [ ] 修改API密钥和配置
- [ ] 检查模型文件路径

### 目录和权限设置
- [ ] 创建必要的目录结构
  - [ ] data/
  - [ ] mysql/data/
  - [ ] uploadfile/
  - [ ] models/SenseVoiceSmall/
- [ ] 设置目录权限
- [ ] 复制模型文件到指定位置

### 防火墙配置
- [ ] 检查防火墙状态
- [ ] 开放端口8000（WebSocket）
- [ ] 开放端口8002（Web管理）
- [ ] 开放端口8003（HTTP服务）
- [ ] 验证端口开放成功

### 启动服务
- [ ] 执行 `offline-deploy.sh` 或手动启动
- [ ] 等待所有容器启动
- [ ] 检查容器运行状态 (`docker ps`)
- [ ] 所有容器状态为 Up/healthy

### 健康检查
- [ ] xiaozhi-esp32-server 容器运行中
- [ ] xiaozhi-esp32-server-web 容器运行中
- [ ] xiaozhi-esp32-server-db 容器运行中且健康
- [ ] xiaozhi-esp32-server-redis 容器运行中且健康
- [ ] 检查容器日志无严重错误

---

## ✅ 四、功能验证阶段

### 网络连通性测试
- [ ] 本地访问 http://localhost:8002
- [ ] 远程访问 http://服务器IP:8002
- [ ] WebSocket连接测试（ws://服务器IP:8000）
- [ ] HTTP服务测试（http://服务器IP:8003）

### Web管理界面测试
- [ ] 可以正常打开登录页面
- [ ] 可以使用管理员账号登录
- [ ] 可以查看设备列表
- [ ] 可以查看系统配置
- [ ] 可以修改配置并保存

### 数据库连接测试
- [ ] Web服务可连接数据库
- [ ] 数据库表结构正确
- [ ] 可以查询和写入数据

### Python服务测试
- [ ] WebSocket服务监听正常
- [ ] 可以建立WebSocket连接
- [ ] 日志输出正常
- [ ] 无异常错误

### 工具函数验证
- [ ] 进入server容器
- [ ] 检查工具函数文件存在
- [ ] 验证新增工具函数（如get_temperature_load_rate）
- [ ] 测试工具函数调用
- [ ] 验证工具函数返回结果正确

### ESP32设备连接测试（如有设备）
- [ ] ESP32可以连接到服务器
- [ ] 语音识别功能正常
- [ ] 语音合成功能正常
- [ ] 交互流程完整

### 性能测试
- [ ] CPU使用率正常（<70%）
- [ ] 内存使用正常（<80%）
- [ ] 磁盘IO正常
- [ ] 网络延迟可接受

---

## 🔧 五、后续配置

### 系统优化
- [ ] 配置自动启动（Docker服务）
- [ ] 配置日志轮转
- [ ] 配置资源限制
- [ ] 优化数据库参数

### 安全加固
- [ ] 修改默认密码
  - [ ] MySQL root密码
  - [ ] 管理员账号密码
  - [ ] Redis密码（如需要）
- [ ] 配置访问控制
- [ ] 启用HTTPS（可选）
- [ ] 配置防火墙规则

### 备份配置
- [ ] 测试备份脚本 `scripts/backup.sh`
- [ ] 配置定时备份任务（crontab）
- [ ] 验证备份文件生成
- [ ] 测试备份恢复流程
- [ ] 规划备份存储位置

### 监控配置
- [ ] 配置容器状态监控
- [ ] 配置资源使用监控
- [ ] 配置日志监控
- [ ] 配置告警通知（可选）

### 文档记录
- [ ] 记录服务器信息
  - IP地址
  - 端口配置
  - 账号密码
- [ ] 记录配置修改
- [ ] 记录已知问题
- [ ] 创建运维手册

---

## 📝 六、交付验收

### 功能验收
- [ ] 所有核心功能正常工作
- [ ] 新增工具函数可用
- [ ] 性能满足要求
- [ ] 无严重错误或告警

### 文档交付
- [ ] 部署文档完整
- [ ] 配置文档清晰
- [ ] 故障排查指南可用
- [ ] 运维手册完善

### 培训交接
- [ ] 基本操作培训
- [ ] 配置修改培训
- [ ] 故障处理培训
- [ ] 备份恢复培训

### 验收签字
- [ ] 功能验收通过
- [ ] 性能验收通过
- [ ] 文档验收通过
- [ ] 培训验收通过

---

## 🆘 七、故障排查清单

如果部署过程中遇到问题，按以下顺序排查：

### 镜像问题
- [ ] 检查镜像文件完整性
- [ ] 验证镜像加载是否成功
- [ ] 检查镜像名称和标签是否正确

### 容器启动问题
- [ ] 查看容器日志 (`docker logs 容器名`)
- [ ] 检查端口冲突
- [ ] 检查数据卷挂载
- [ ] 检查环境变量配置

### 网络问题
- [ ] 检查防火墙规则
- [ ] 检查端口监听状态
- [ ] 检查容器网络连接
- [ ] 测试内部服务通信

### 数据库问题
- [ ] 检查MySQL容器状态
- [ ] 查看MySQL日志
- [ ] 验证数据库密码
- [ ] 检查数据库初始化

### 性能问题
- [ ] 检查系统资源使用
- [ ] 检查容器资源限制
- [ ] 优化配置参数
- [ ] 调整服务数量

---

## 📞 支持联系

如果遇到无法解决的问题：

1. 查看详细部署指南：`offline-deployment-guide.md`
2. 查看项目文档：https://github.com/xinnan-tech/xiaozhi-esp32-server/tree/main/docs
3. 提交Issue：https://github.com/xinnan-tech/xiaozhi-esp32-server/issues

---

**祝您部署顺利！**

完成检查清单后，您的小智ESP32服务器应该已经成功部署并稳定运行。

