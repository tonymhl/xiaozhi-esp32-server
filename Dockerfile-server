# ----- 构建阶段 -----
FROM python:3.10-slim AS builder
WORKDIR /app

# 1. 国内 PyPI 镜像 + 超时参数
ENV PIP_INDEX_URL=https://mirrors.aliyun.com/pypi/simple
ENV PIP_TRUSTED_HOST=mirrors.aliyun.com
ENV PIP_TIMEOUT=120
ENV PIP_RETRIES=5

COPY main/xiaozhi-server/requirements.txt .

# 2. 一条命令装完所有依赖（CPU 版 torch 优先）
RUN pip install --no-cache-dir -U pip setuptools wheel && \
    pip install --no-cache-dir \
        --index-url https://mirrors.aliyun.com/pytorch-wheels/cpu \
        torch==2.2.2+cpu torchaudio==2.2.2+cpu && \
    pip install --no-cache-dir -r requirements.txt

# ----- 生产阶段 -----
FROM python:3.10-slim
WORKDIR /opt/xiaozhi-esp32-server

RUN apt-get update && \
    apt-get install -y --no-install-recommends libopus0 ffmpeg && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

COPY --from=builder /usr/local/lib/python3.10/site-packages \
                    /usr/local/lib/python3.10/site-packages
COPY --from=builder /usr/local/bin/mcp-proxy /usr/local/bin/mcp-proxy
COPY main/xiaozhi-server .
CMD ["python", "app.py"]